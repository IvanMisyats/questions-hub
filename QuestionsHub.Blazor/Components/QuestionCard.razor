@using QuestionsHub.Blazor.Domain
@using QuestionsHub.Blazor.Infrastructure
@inject IJSRuntime JS
@inject NavigationManager Navigation

<div class="question-card">
    <div class="question-header">
        <span class="question-number">Питання @Question.Number</span>
        <button class="btn btn-sm copy-link-btn" @onclick="CopyQuestionLink" title="Скопіювати посилання на питання">
            @if (_copied)
            {
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="copy-icon copied" viewBox="0 0 16 16">
                    <path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425z"/>
                </svg>
            }
            else
            {
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="copy-icon" viewBox="0 0 16 16">
                    <path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1 1 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4 4 0 0 1-.128-1.287z"/>
                    <path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243z"/>
                </svg>
            }
        </button>
    </div>

    @if (!string.IsNullOrEmpty(Question.HostInstructions))
    {
        <div class="host-instructions">
            <strong>Вказівка ведучому:</strong>
            <div>@Question.HostInstructions</div>
        </div>
    }

    @if (!string.IsNullOrEmpty(Question.HandoutText))
    {
        <div class="handout">
            <strong>Роздатковий матеріал:</strong>
            <div>@Question.HandoutText</div>
        </div>
    }

    @if (!string.IsNullOrEmpty(Question.HandoutUrl))
    {
        <div class="handout">
            <strong>Роздатковий матеріал:</strong>
            <div class="media-container">
                @{
                    var handoutMediaType = MediaSecurityOptions.GetMediaType(Question.HandoutUrl);
                }
                @switch (handoutMediaType)
                {
                    case MediaType.Image:
                        <img src="@Question.HandoutUrl" alt="Handout" class="img-fluid mt-2" style="max-height: 300px;" />
                        break;
                    case MediaType.Video:
                        <video controls class="mt-2" style="max-width: 100%; max-height: 400px;">
                            <source src="@Question.HandoutUrl" type="@MediaSecurityOptions.GetContentTypeFromPath(Question.HandoutUrl)" />
                            Ваш браузер не підтримує відтворення відео.
                        </video>
                        break;
                    case MediaType.Audio:
                        <audio controls class="mt-2" style="width: 100%; max-width: 500px;">
                            <source src="@Question.HandoutUrl" type="@MediaSecurityOptions.GetContentTypeFromPath(Question.HandoutUrl)" />
                            Ваш браузер не підтримує відтворення аудіо.
                        </audio>
                        break;
                }
            </div>
        </div>
    }

    <div class="question-text">
        @Question.Text
    </div>

    <div class="answer-toggle-section mt-3">
        <button class="btn btn-link answer-toggle p-0" @onclick="ToggleAnswer">
            @if (_showAnswer)
            {
                <text>Сховати відповідь</text>
            }
            else
            {
                <text>Показати відповідь</text>
            }
        </button>
    </div>

    @if (_showAnswer)
    {
        <div class="answer-section">
            <div class="answer-field">
                <span class="answer-label">Відповідь:</span> @Question.Answer
            </div>

            @if (!string.IsNullOrEmpty(Question.AcceptedAnswers))
            {
                <div class="answer-field">
                    <span class="answer-label">Залік:</span> @Question.AcceptedAnswers
                </div>
            }

            @if (!string.IsNullOrEmpty(Question.RejectedAnswers))
            {
                <div class="answer-field">
                    <span class="answer-label">Незалік:</span> @Question.RejectedAnswers
                </div>
            }

            @if (!string.IsNullOrEmpty(Question.Comment))
            {
                <div class="answer-field">
                    <span class="answer-label">Коментар:</span> @Question.Comment
                </div>
            }

            @if (!string.IsNullOrEmpty(Question.CommentAttachmentUrl))
            {
                <div class="answer-field">
                    <span class="answer-label">Матеріал до коментаря:</span>
                    <div class="media-container">
                        @{
                            var commentMediaType = MediaSecurityOptions.GetMediaType(Question.CommentAttachmentUrl);
                        }
                        @switch (commentMediaType)
                        {
                            case MediaType.Image:
                                <img src="@Question.CommentAttachmentUrl" alt="Comment attachment" class="img-fluid mt-2" style="max-height: 300px;" />
                                break;
                            case MediaType.Video:
                                <video controls class="mt-2" style="max-width: 100%; max-height: 400px;">
                                    <source src="@Question.CommentAttachmentUrl" type="@MediaSecurityOptions.GetContentTypeFromPath(Question.CommentAttachmentUrl)" />
                                    Ваш браузер не підтримує відтворення відео.
                                </video>
                                break;
                            case MediaType.Audio:
                                <audio controls class="mt-2" style="width: 100%; max-width: 500px;">
                                    <source src="@Question.CommentAttachmentUrl" type="@MediaSecurityOptions.GetContentTypeFromPath(Question.CommentAttachmentUrl)" />
                                    Ваш браузер не підтримує відтворення аудіо.
                                </audio>
                                break;
                        }
                    </div>
                </div>
            }

            @if (!string.IsNullOrEmpty(Question.Source))
            {
                <div class="answer-field">
                    <span class="answer-label">Джерело:</span> @Question.Source
                </div>
            }

            @if (Question.Authors.Any())
            {
                <div class="answer-field">
                    <span class="answer-label">Автор(и):</span>
                    @for (var i = 0; i < Question.Authors.Count; i++)
                    {
                        var author = Question.Authors[i];
                        @(" ")<a href="/editor/@author.Id">@author.FullName</a>@(i < Question.Authors.Count - 1 ? "," : "")
                    }
                </div>
            }
        </div>
    }
</div>

@code {
    [Parameter]
    public required Question Question { get; set; }

    private bool _showAnswer;
    private bool _copied;

    private void ToggleAnswer()
    {
        _showAnswer = !_showAnswer;
    }

    private async Task CopyQuestionLink()
    {
        var baseUri = Navigation.BaseUri.TrimEnd('/');
        var questionUrl = $"{baseUri}/question/{Question.Id}";
        
        var success = await JS.InvokeAsync<bool>("copyToClipboard", questionUrl);
        if (success)
        {
            _copied = true;
            StateHasChanged();
            
            await Task.Delay(2000);
            _copied = false;
            StateHasChanged();
        }
    }
}

