@* Static SSR - uses HttpContext for authentication state *@

@if (_isAuthenticated)
{
    <div class="dropdown">
        <button class="btn btn-outline-primary dropdown-toggle" type="button" id="userMenuDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            @_userName
        </button>
        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenuDropdown">
            <li><a class="dropdown-item" href="/Account/Profile">Мій профіль</a></li>
            @if (_isEditor || _isAdmin)
            {
                <li><a class="dropdown-item" href="/manage/packages">Мої пакети</a></li>
                <li><a class="dropdown-item" href="/admin/editors">Редактори</a></li>
            }
            @if (_isAdmin)
            {
                <li><a class="dropdown-item" href="/admin/users">Користувачі</a></li>
            }
            <li><hr class="dropdown-divider"></li>
            <li>
                <form method="post" action="/api/Auth/logout">
                    <button type="submit" class="dropdown-item">Вийти</button>
                </form>
            </li>
        </ul>
    </div>
}
else
{
    <a href="/Account/Login" class="btn btn-primary me-2">Увійти</a>
    <a href="/Account/Register" class="btn btn-outline-primary">Реєстрація</a>
}

@code {
    [CascadingParameter]
    private HttpContext? HttpContext { get; set; }

    private bool _isAuthenticated;
    private bool _isEditor;
    private bool _isAdmin;
    private string _userName = "Користувач";

    protected override void OnInitialized()
    {
        var user = HttpContext?.User;
        _isAuthenticated = user?.Identity?.IsAuthenticated ?? false;

        if (_isAuthenticated && user != null)
        {
            _isAdmin = user.IsInRole("Admin");
            _isEditor = user.IsInRole("Editor");

            // Get name from claims (added during login)
            var firstName = user.FindFirst("FirstName")?.Value;
            var lastName = user.FindFirst("LastName")?.Value;

            if (!string.IsNullOrEmpty(firstName) || !string.IsNullOrEmpty(lastName))
            {
                _userName = $"{firstName} {lastName}".Trim();
            }
            else
            {
                // Fallback to email if claims not set
                _userName = user.Identity?.Name ?? "Користувач";
            }
        }
    }
}

