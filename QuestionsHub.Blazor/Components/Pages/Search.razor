@page "/search"
@page "/search/{Query}"
@attribute [StreamRendering]
@using QuestionsHub.Blazor.Infrastructure
@using static QuestionsHub.Blazor.Infrastructure.HighlightSanitizer
@using static QuestionsHub.Blazor.Infrastructure.SourceLinkifier
@inject SearchService SearchService
@inject AccessControlService AccessControl

<PageTitle>–ü–æ—à—É–∫ –ø–∏—Ç–∞–Ω—å</PageTitle>

<div class="container-fluid">
    <h4 class="mb-4">–ü–æ—à—É–∫ –∑–∞–ø–∏—Ç–∞–Ω—å</h4>

    <div class="row mb-4">
        <div class="col-12 col-md-8 col-lg-6">
            <form class="input-group" data-enhance="false" onsubmit="return handleSearchFormSubmit(this)">
                <input type="text"
                       name="q"
                       class="form-control form-control-lg"
                       placeholder="–í–≤–µ–¥—ñ—Ç—å —Å–ª–æ–≤–∞ –¥–ª—è –ø–æ—à—É–∫—É..."
                       value="@_searchedQuery" />
                <button type="submit" class="btn btn-primary">
                    <span>–®—É–∫–∞—Ç–∏</span>
                </button>
            </form>
            <small class="text-muted mt-2 d-block">
                –ü—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è: <code>—Å–ª–æ–≤–æ1 —Å–ª–æ–≤–æ2</code> (–æ–±–∏–¥–≤–∞), <code>—Å–ª–æ–≤–æ1 OR —Å–ª–æ–≤–æ2</code> (–±—É–¥—å-—è–∫–µ),
                <code>"—Ç–æ—á–Ω–∞ —Ñ—Ä–∞–∑–∞"</code>, <code>-–≤–∏–∫–ª—é—á–∏—Ç–∏</code>
            </small>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="alert alert-danger" role="alert">
            @_errorMessage
        </div>
    }

    @if (_isLoading)
    {
        <div class="d-flex align-items-center text-muted">
            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
            <span>–®—É–∫–∞—é...</span>
        </div>
    }
    else if (_results != null)
    {
        @if (_results.Count > 0)
        {
            <p class="text-muted mb-3">
                –ó–Ω–∞–π–¥–µ–Ω–æ <strong>@_results.Count</strong> —Ä–µ–∑—É–ª—å—Ç–∞—Ç(—ñ–≤)
                @if (!string.IsNullOrEmpty(_searchedQuery))
                {
                    <span> –∑–∞ –∑–∞–ø–∏—Ç–æ–º ¬´@_searchedQuery¬ª</span>
                }
            </p>

            <div class="row">
                @foreach (var result in _results)
                {
                    <div class="col-12 mb-4">
                        <div class="card search-result-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <div>
                                    <a href="/package/@result.PackageId" class="text-decoration-none fw-bold">@result.PackageTitle</a>
                                    <span class="text-muted mx-2">¬∑</span>
                                    <span class="text-muted">–¢—É—Ä @result.TourNumber</span>
                                    <span class="text-muted mx-2">¬∑</span>
                                    <span class="text-muted">–ó–∞–ø–∏—Ç–∞–Ω–Ω—è @result.QuestionNumber</span>
                                </div>
                                <a href="/package/@result.PackageId#question-@result.QuestionId"
                                   class="btn btn-sm btn-outline-primary">
                                    –ü–µ—Ä–µ–π—Ç–∏ –¥–æ –ø–∞–∫–µ—Ç—É
                                </a>
                            </div>
                            <div class="card-body">
                                <div class="@(result.IsAdult ? "adult-blur-wrapper blurred" : "")" data-package-id="@result.PackageId">
                                    @if (result.IsAdult)
                                    {
                                        <div class="adult-reveal-overlay" onclick="revealAdultContent(this)">
                                            <span>üîû –í–º—ñ—Å—Ç 18+. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å, —â–æ–± –ø–æ–∫–∞–∑–∞—Ç–∏.</span>
                                        </div>
                                    }

                                    @* Handout if present *@
                                    @if (!string.IsNullOrEmpty(result.HandoutText))
                                    {
                                        <div class="handout mb-3">
                                            <strong>–†–æ–∑–¥–∞—Ç–∫–æ–≤–∏–π –º–∞—Ç–µ—Ä—ñ–∞–ª:</strong>
                                            <div>@Sanitize(result.HandoutTextHighlighted, result.HandoutText, _searchedQuery)</div>
                                        </div>
                                    }

                                    @if (!string.IsNullOrEmpty(result.HandoutUrl))
                                    {
                                        <div class="handout mb-3">
                                            <strong>–†–æ–∑–¥–∞—Ç–∫–æ–≤–∏–π –º–∞—Ç–µ—Ä—ñ–∞–ª:</strong>
                                            <MediaDisplay Url="@result.HandoutUrl" Alt="Handout" />
                                        </div>
                                    }

                                    @* Full question text *@
                                    <div class="question-text mb-3">
                                        @Sanitize(result.TextHighlighted, result.Text, _searchedQuery)
                                    </div>

                                    @* Answer section *@
                                    <div class="answer-section">
                                        <div class="answer-field">
                                            <span class="answer-label">–í—ñ–¥–ø–æ–≤—ñ–¥—å:</span> @Sanitize(result.AnswerHighlighted, result.Answer, _searchedQuery)
                                        </div>

                                        @if (!string.IsNullOrEmpty(result.AcceptedAnswers))
                                        {
                                            <div class="answer-field">
                                                <span class="answer-label">–ó–∞–ª—ñ–∫:</span> @Sanitize(result.AcceptedAnswersHighlighted, result.AcceptedAnswers, _searchedQuery)
                                            </div>
                                        }

                                        @if (!string.IsNullOrEmpty(result.RejectedAnswers))
                                        {
                                            <div class="answer-field">
                                                <span class="answer-label">–ù–µ–∑–∞–ª—ñ–∫:</span> @Sanitize(result.RejectedAnswersHighlighted, result.RejectedAnswers, _searchedQuery)
                                            </div>
                                        }

                                        @if (!string.IsNullOrEmpty(result.Comment))
                                        {
                                            <div class="answer-field">
                                                <span class="answer-label">–ö–æ–º–µ–Ω—Ç–∞—Ä:</span> @Sanitize(result.CommentHighlighted, result.Comment, _searchedQuery)
                                            </div>
                                        }

                                        @if (!string.IsNullOrEmpty(result.CommentAttachmentUrl))
                                        {
                                            <div class="answer-field">
                                                <span class="answer-label">–ú–∞—Ç–µ—Ä—ñ–∞–ª –¥–æ –∫–æ–º–µ–Ω—Ç–∞—Ä—è:</span>
                                                <MediaDisplay Url="@result.CommentAttachmentUrl" Alt="Comment attachment" />
                                            </div>
                                        }

                                        @if (!string.IsNullOrEmpty(result.Source))
                                        {
                                            <div class="answer-field source-field">
                                                <span class="answer-label">–î–∂–µ—Ä–µ–ª–æ:</span> @Linkify(Sanitize(result.SourceHighlighted, result.Source, _searchedQuery))
                                            </div>
                                        }

                                        @if (!string.IsNullOrEmpty(result.Authors))
                                        {
                                            <div class="answer-field">
                                                <span class="answer-label">–ê–≤—Ç–æ—Ä(–∏):</span> <span class="authors-list">@foreach (var (authorId, authorName, isLast) in ParseAuthors(result.Authors)){<a href="/editor/@authorId">@authorName</a>@(isLast ? "" : ", ")}</span>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else if (_hasSearched)
        {
            <div class="alert alert-info" role="alert">
                <strong>–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</strong> –∑–∞ –∑–∞–ø–∏—Ç–æ–º ¬´@_searchedQuery¬ª.
                <br />
                <small>–°–ø—Ä–æ–±—É–π—Ç–µ —ñ–Ω—à—ñ —Å–ª–æ–≤–∞ –∞–±–æ –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ –Ω–∞–ø–∏—Å–∞–Ω–Ω—è.</small>
            </div>
        }
    }
</div>

@code {
    [Parameter]
    public string? Query { get; set; }

    private List<SearchResult>? _results;
    private bool _isLoading = true;
    private bool _hasSearched;
    private string? _errorMessage;
    private string? _searchedQuery;

    protected override async Task OnInitializedAsync()
    {
        // If query passed via URL parameter, perform search
        if (!string.IsNullOrWhiteSpace(Query))
        {
            _searchedQuery = Uri.UnescapeDataString(Query);
            await PerformSearch();
        }
        else
        {
            _isLoading = false;
        }
    }

    private async Task PerformSearch()
    {
        if (string.IsNullOrWhiteSpace(_searchedQuery))
        {
            _isLoading = false;
            return;
        }

        try
        {
            var accessContext = await AccessControl.GetPackageAccessContext();
            _results = await SearchService.Search(_searchedQuery.Trim(), accessContext);
            _hasSearched = true;
        }
        catch (Exception)
        {
            _errorMessage = "–ü–æ–º–∏–ª–∫–∞ –ø–æ—à—É–∫—É. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑ –ø—ñ–∑–Ω—ñ—à–µ.";
            _results = null;
        }
        finally
        {
            _isLoading = false;
        }
    }

    /// <summary>
    /// Parses the authors string from search results into individual author tuples.
    /// Format: "id:Name|id:Name"
    /// </summary>
    private static IEnumerable<(int AuthorId, string Name, bool IsLast)> ParseAuthors(string authors)
    {
        var parts = authors.Split('|', StringSplitOptions.RemoveEmptyEntries);
        for (var i = 0; i < parts.Length; i++)
        {
            var colonIndex = parts[i].IndexOf(':');
            if (colonIndex > 0 && int.TryParse(parts[i][..colonIndex], out var id))
            {
                yield return (id, parts[i][(colonIndex + 1)..], i == parts.Length - 1);
            }
        }
    }
}

