@page "/"
@attribute [StreamRendering]
@using Microsoft.AspNetCore.WebUtilities
@using QuestionsHub.Blazor.Domain
@using QuestionsHub.Blazor.Infrastructure
@using QuestionsHub.Blazor.Utils
@inject PackageListService PackageListService
@inject TagService TagService
@inject AccessControlService AccessControl
@inject NavigationManager NavigationManager

<PageTitle>База українських запитань Що?Де?Коли?</PageTitle>

@* Hidden state for JavaScript *@
<div id="page-state" 
     data-search="@_searchTerm" 
     data-editor-id="@_editorId" 
     data-editor-name="@_selectedEditorName"
     data-tag-id="@_tagId"
     data-tag-name="@_selectedTagName"
     data-sort="@_sortField"
     data-dir="@_sortDir"
     data-page="@CurrentPage"
     data-total-pages="@_totalPages"
     data-total-count="@_totalCount"
     data-has-filters="@((!string.IsNullOrEmpty(_searchTerm) || _editorId.HasValue || _tagId.HasValue).ToString().ToLowerInvariant())"
     style="display:none;"></div>

<div class="container-fluid">
    @* Popular tags *@
    @if (_popularTags?.Count > 0)
    {
        <div id="popular-tags-section" class="mb-3" data-total-tags="@_popularTags.Count">
            <div class="d-flex flex-wrap align-items-center gap-2">
                <span class="small text-muted">Популярні теги:</span>
                @for (var i = 0; i < _popularTags.Count; i++)
                {
                    var tag = _popularTags[i];
                    <button type="button"
                            class="btn btn-sm rounded-pill tag-filter-btn @(_tagId == tag.Id ? "btn-primary" : "btn-outline-primary") @(i >= 10 ? "tag-hidden" : "")"
                            data-tag-id="@tag.Id"
                            data-tag-name="@tag.Name"
                            data-tag-index="@i">
                        @tag.Name
                    </button>
                }
                @if (_popularTags.Count > 10)
                {
                    <button type="button" class="btn btn-sm rounded-pill btn-outline-secondary" id="tag-expand-btn">
                        +@(_popularTags.Count - 10) ще
                    </button>
                }
                @if (_tagId.HasValue)
                {
                    <button type="button" class="btn btn-sm btn-outline-secondary rounded-pill" id="clear-tag-btn">
                        <Icon Name="close" Class="me-1" /> Скинути
                    </button>
                }
            </div>
        </div>
    }

    @* Filter toggle for mobile *@
    <div class="d-md-none mb-3">
        <button type="button" class="btn btn-outline-secondary w-100" id="filter-toggle" aria-expanded="false" aria-controls="filter-panel">
            <Icon Name="funnel" Class="me-2" /> Фільтри та сортування
        </button>
    </div>

    @* Filter panel - collapsible on mobile, always visible on desktop *@
    <div id="filter-panel" class="filter-panel mb-4">
        <div class="row g-3 align-items-end">
            @* Package search *@
            <div class="col-12 col-md-4 col-lg-4">
                <label for="package-search" class="form-label small text-muted mb-1">Пошук пакетів</label>
                <div class="input-group">
                    <span class="input-group-text">
                        <Icon Name="search" />
                    </span>
                    <input type="text"
                           class="form-control"
                           id="package-search"
                           name="package-search"
                           placeholder="Назва пакету..."
                           value="@_searchTerm"
                           autocomplete="off">
                </div>
            </div>

            @* Editor filter dropdown *@
            <div class="col-12 col-md-4 col-lg-4">
                <label for="editor-dropdown-btn" class="form-label small text-muted mb-1">Редактор</label>
                <div class="dropdown" id="editor-dropdown">
                    <button type="button"
                            id="editor-dropdown-btn"
                            class="form-select text-start dropdown-toggle"
                            data-editor-id="@_editorId"
                            data-editor-name="@_selectedEditorName">
                        <span class="text-truncate">@_selectedEditorName</span>
                    </button>
                    <div class="dropdown-menu w-100">
                        <div class="px-2 pb-2">
                            <input type="text"
                                   class="form-control form-control-sm"
                                   id="editor-search"
                                   name="editor-search"
                                   placeholder="Пошук редактора..."
                                   autocomplete="off">
                        </div>
                        <div id="editor-list" class="editor-list">
                            @* Populated by JavaScript *@
                        </div>
                    </div>
                </div>
            </div>

            @* Sort options *@
            <div class="col-12 col-md-4 col-lg-4">
                <label for="sort-select" class="form-label small text-muted mb-1">Сортування</label>
                <div class="input-group">
                    <select class="form-select" id="sort-select">
                        <option value="PublicationDate" selected="@(_sortField == PackageSortField.PublicationDate)">За датою публікації</option>
                        <option value="PlayedFrom" selected="@(_sortField == PackageSortField.PlayedFrom)">За датою гри</option>
                    </select>
                    <button type="button" class="btn btn-outline-secondary" id="sort-dir-btn" title="@(_sortDir == SortDirection.Desc ? "Спадання" : "Зростання")">
                        @if (_sortDir == SortDirection.Desc)
                        {
                            <Icon Name="sort-down" />
                        }
                        else
                        {
                            <Icon Name="sort-up" />
                        }
                    </button>
                </div>
            </div>
        </div>


    </div>

    @* Results header *@
    <div id="results-header" class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="mb-0">
            @if (!string.IsNullOrEmpty(_searchTerm) || _editorId.HasValue)
            {
                <span>Знайдено <strong id="packages-count">@_totalCount</strong> пакетів</span>
            }
            else
            {
                <span>Пакетів на сайті <strong id="packages-count">@_totalCount</strong></span>
            }
        </h4>
    </div>

    @* Package list *@
    <div id="packages-section">
        @if (_packages == null)
        {
            <div id="loading-indicator"><em>Завантаження...</em></div>
        }
        else if (!_packages.Any())
        {
            <div id="no-results">
                @if (!string.IsNullOrEmpty(_searchTerm) || _editorId.HasValue)
                {
                    <div class="alert alert-info">
                        <p class="mb-2">За вашим запитом нічого не знайдено.</p>
                        <a href="/" class="btn btn-sm btn-outline-primary" id="reset-filters-btn">Скинути фільтри</a>
                    </div>
                }
                else
                {
                    <p>Поки немає пакетів. Слідкуйте за оновленнями.</p>
                }
            </div>
        }
        else
        {
            <div id="packages-container" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                @foreach (var package in _packages)
                {
                    <div class="col">
                        <a href="/package/@package.Id" class="text-decoration-none text-reset">
                            <div class="card h-100 package-card">
                                <div class="card-body">
                                    <h5 class="card-title">@package.Title</h5>
                                    <p class="card-text text-muted mb-2">
                                        <small>
                                            <strong>@package.QuestionsCount</strong> запитань
                                            @{ var playedPeriod = PlayedPeriodFormatter.Format(package.PlayedFrom, package.PlayedTo); }
                                            @if (!string.IsNullOrEmpty(playedPeriod))
                                            {
                                                <span> · @playedPeriod</span>
                                            }
                                        </small>
                                    </p>
                                    @if (package.PublicationDate.HasValue)
                                    {
                                        <p class="card-text text-muted mb-2">
                                            <small>
                                                <strong>Опубліковано:</strong> <span data-utc="@package.PublicationDate.Value.ToString("o")"></span>
                                            </small>
                                        </p>
                                    }
                                    @if (!string.IsNullOrEmpty(package.Description))
                                    {
                                        <p class="card-text small">@package.Description</p>
                                    }
                                    @if (package.Editors.Any())
                                    {
                                        <p class="card-text">
                                            <small class="text-muted">
                                                <strong>Редактори:</strong>
                                                @for (var i = 0; i < package.Editors.Count; i++)
                                                {
                                                    var editor = package.Editors[i];
                                                    @(" ")<a href="/editor/@editor.Id" class="text-muted">@editor.FullName</a>@(i < package.Editors.Count - 1 ? " ·" : "")
                                                }
                                            </small>
                                        </p>
                                    }                                    @if (package.Tags.Any())
                                    {
                                        <div class="d-flex flex-wrap gap-1 mt-2">
                                            @foreach (var tag in package.Tags)
                                            {
                                                <span class="badge rounded-pill bg-primary package-tag" data-tag-id="@tag.Id">@tag.Name</span>
                                            }
                                        </div>
                                    }                                </div>
                            </div>
                        </a>
                    </div>
                }
            </div>

            <div id="pagination-container">
                <Pagination CurrentPage="CurrentPage" TotalPages="_totalPages" BaseUrl="@_paginationBaseUrl" JsIntercepted="true" />
            </div>
        }
    </div>
</div>

<script src="/home-filters.js"></script>

@code {
    private const int PageSize = 24;

    // Query parameters - page is handled by JS now, not route parameter
    [SupplyParameterFromQuery(Name = "search")]
    public string? SearchParam { get; set; }

    [SupplyParameterFromQuery(Name = "editor")]
    public int? EditorParam { get; set; }

    [SupplyParameterFromQuery(Name = "tag")]
    public int? TagParam { get; set; }

    [SupplyParameterFromQuery(Name = "sort")]
    public string? SortParam { get; set; }

    [SupplyParameterFromQuery(Name = "dir")]
    public string? DirParam { get; set; }

    [SupplyParameterFromQuery(Name = "page")]
    public int? PageParam { get; set; }

    // State
    private List<PackageCardDto>? _packages;
    private int _totalCount;
    private int _totalPages;
    private string? _searchTerm;
    private int? _editorId;
    private string _selectedEditorName = "Всі редактори";
    private int? _tagId;
    private string _selectedTagName = "";
    private List<TagBriefDto>? _popularTags;
    private PackageSortField _sortField = PackageSortField.PublicationDate;
    private SortDirection _sortDir = SortDirection.Desc;
    private string _paginationBaseUrl = "";

    private int CurrentPage => PageParam.HasValue && PageParam.Value >= 1 ? PageParam.Value : 1;

    protected override async Task OnInitializedAsync()
    {
        ParseQueryParameters();
        await LoadSelectedEditorName();
        await LoadPopularTags();
        BuildPaginationBaseUrl();
        await LoadPackages();
    }

    private void ParseQueryParameters()
    {
        _searchTerm = SearchParam;
        _editorId = EditorParam;
        _tagId = TagParam;

        // Parse sort field
        if (!string.IsNullOrEmpty(SortParam) &&
            Enum.TryParse<PackageSortField>(SortParam, ignoreCase: true, out var sortField))
        {
            _sortField = sortField;
        }

        // Parse sort direction
        if (!string.IsNullOrEmpty(DirParam) &&
            Enum.TryParse<SortDirection>(DirParam, ignoreCase: true, out var sortDir))
        {
            _sortDir = sortDir;
        }
    }

    private async Task LoadSelectedEditorName()
    {
        if (_editorId.HasValue)
        {
            var editor = await PackageListService.GetEditorById(_editorId.Value);
            _selectedEditorName = editor?.FullName ?? "Всі редактори";
        }
    }

    private void BuildPaginationBaseUrl()
    {
        var queryParams = new List<string>();

        if (!string.IsNullOrEmpty(_searchTerm))
            queryParams.Add($"search={Uri.EscapeDataString(_searchTerm)}");

        if (_editorId.HasValue)
            queryParams.Add($"editor={_editorId.Value}");

        if (_tagId.HasValue)
            queryParams.Add($"tag={_tagId.Value}");

        if (_sortField != PackageSortField.PublicationDate)
            queryParams.Add($"sort={_sortField}");

        if (_sortDir != SortDirection.Desc)
            queryParams.Add($"dir={_sortDir}");

        _paginationBaseUrl = queryParams.Count > 0 ? $"?{string.Join("&", queryParams)}" : "";
    }

    private string GetUrlWithoutParam(string paramToRemove)
    {
        var queryParams = new List<string>();

        if (paramToRemove != "search" && !string.IsNullOrEmpty(_searchTerm))
            queryParams.Add($"search={Uri.EscapeDataString(_searchTerm)}");

        if (paramToRemove != "editor" && _editorId.HasValue)
            queryParams.Add($"editor={_editorId.Value}");

        if (paramToRemove != "tag" && _tagId.HasValue)
            queryParams.Add($"tag={_tagId.Value}");

        if (_sortField != PackageSortField.PublicationDate)
            queryParams.Add($"sort={_sortField}");

        if (_sortDir != SortDirection.Desc)
            queryParams.Add($"dir={_sortDir}");

        return queryParams.Count > 0 ? $"/?{string.Join("&", queryParams)}" : "/";
    }

    private async Task LoadPackages()
    {
        var accessContext = await AccessControl.GetPackageAccessContext();

        var filter = new PackageListFilter(
            TitleSearch: _searchTerm,
            EditorId: _editorId,
            TagId: _tagId,
            SortField: _sortField,
            SortDir: _sortDir,
            Page: CurrentPage,
            PageSize: PageSize
        );

        var result = await PackageListService.SearchPackages(filter, accessContext);

        _packages = result.Packages;
        _totalCount = result.TotalCount;
        _totalPages = result.TotalPages;
    }

    private async Task LoadPopularTags()
    {
        _popularTags = await TagService.GetPopularPublished();

        // Resolve selected tag name from popular tags or DB
        if (_tagId.HasValue && _popularTags != null)
        {
            var selectedTag = _popularTags.FirstOrDefault(t => t.Id == _tagId.Value);
            _selectedTagName = selectedTag?.Name ?? "";
        }
    }
}
