@page "/"
@page "/{Page:int}"
@attribute [StreamRendering]
@using Microsoft.EntityFrameworkCore
@using QuestionsHub.Blazor.Data
@using QuestionsHub.Blazor.Domain
@using QuestionsHub.Blazor.Infrastructure
@using QuestionsHub.Blazor.Utils
@inject QuestionsHubDbContext DbContext
@inject AccessControlService AccessControl
<PageTitle>База українських запитань Що?Де?Коли?</PageTitle>
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="mb-0">Пакетів на сайті <strong>@_totalCount</strong></h4>
    </div>
    @if (_packages == null)
    {
        <p><em>Завантаження...</em></p>
    }
    else if (!_packages.Any())
    {
        <p>Поки немає пакетів. Слідкуйте за оновленнями.</p>
    }
    else
    {
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
            @foreach (var package in _packages)
            {
                <div class="col">
                    <a href="/package/@package.Id" class="text-decoration-none text-reset">
                        <div class="card h-100 package-card">
                            <div class="card-body">
                                <h5 class="card-title">@package.Title</h5>
                                <p class="card-text text-muted mb-2">
                                    <small>
                                        <strong>@package.QuestionsCount</strong> запитань
                                        @{ var playedPeriod = PlayedPeriodFormatter.Format(package.PlayedFrom, package.PlayedTo); }
                                        @if (!string.IsNullOrEmpty(playedPeriod))
                                        {
                                            <span> · @playedPeriod</span>
                                        }
                                    </small>
                                </p>
                                @if (package.PublicationDate.HasValue)
                                {
                                    <p class="card-text text-muted mb-2">
                                        <small>
                                            <strong>Опубліковано:</strong> <span data-utc="@package.PublicationDate.Value.ToString("o")"></span>
                                        </small>
                                    </p>
                                }
                                @if (!string.IsNullOrEmpty(package.Description))
                                {
                                    <p class="card-text small">@package.Description</p>
                                }
                                @if (package.Editors.Any())
                                {
                                    <p class="card-text">
                                        <small class="text-muted">
                                            <strong>Редактори:</strong>
                                            @for (var i = 0; i < package.Editors.Count; i++)
                                            {
                                                var editor = package.Editors[i];
                                                @(" ")<a href="/editor/@editor.Id" class="text-muted">@editor.FullName</a>@(i < package.Editors.Count - 1 ? " ·" : "")
                                            }
                                        </small>
                                    </p>
                                }
                            </div>
                        </div>
                    </a>
                </div>
            }
        </div>

        <Pagination CurrentPage="CurrentPage" TotalPages="_totalPages" BaseUrl="" />
    }
</div>
@code {
    private const int PageSize = 24;

    [Parameter]
    public int Page { get; set; } = 1;

    private List<PackageCardDto>? _packages;
    private int _totalCount;
    private int _totalPages;

    private int CurrentPage => Page < 1 ? 1 : Page;

    private record PackageCardDto(
        int Id,
        string Title,
        string? Description,
        DateTime? PublicationDate,
        DateOnly? PlayedFrom,
        DateOnly? PlayedTo,
        int QuestionsCount,
        List<EditorDto> Editors);

    private record EditorDto(int Id, string FirstName, string LastName)
    {
        public string FullName => $"{FirstName} {LastName}";
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadPackages();
    }

    private async Task LoadPackages()
    {
        var accessContext = await AccessControl.GetPackageAccessContext();
        var accessFilter = accessContext.GetAccessFilter();

        var baseQuery = DbContext.Packages
            .AsNoTracking()
            .Where(p => p.Status == PackageStatus.Published)
            .Where(accessFilter);

        _totalCount = await baseQuery.CountAsync();
        _totalPages = (int)Math.Ceiling((double)_totalCount / PageSize);

        // First query: Get basic package data and questions count
        var packageData = await baseQuery
            .OrderByDescending(p => p.Id)
            .Skip((CurrentPage - 1) * PageSize)
            .Take(PageSize)
            .Select(p => new
            {
                p.Id,
                p.Title,
                p.Description,
                p.PublicationDate,
                p.PlayedFrom,
                p.PlayedTo,
                QuestionsCount = p.Tours.SelectMany(t => t.Questions).Count()
            })
            .ToListAsync();

        var packageIds = packageData.Select(p => p.Id).ToList();

        // Second query: Get editors for these packages using Include (simpler, EF Core handles it)
        var packagesWithEditors = await DbContext.Packages
            .AsNoTracking()
            .Where(p => packageIds.Contains(p.Id))
            .Include(p => p.PackageEditors)
            .Include(p => p.Tours)
                .ThenInclude(t => t.Editors)
            .Include(p => p.Tours)
                .ThenInclude(t => t.Blocks)
                    .ThenInclude(b => b.Editors)
            .ToDictionaryAsync(p => p.Id);

        // Map to DTOs in memory
        _packages = packageData
            .Select(p =>
            {
                var pkg = packagesWithEditors.GetValueOrDefault(p.Id);

                // Explicitly gather editors from all sources
                var allEditors = new List<Author>();
                if (pkg != null)
                {
                    // Add package-level editors
                    allEditors.AddRange(pkg.PackageEditors);

                    // Add tour and block editors
                    foreach (var tour in pkg.Tours)
                    {
                        allEditors.AddRange(tour.Editors);
                        foreach (var block in tour.Blocks)
                        {
                            allEditors.AddRange(block.Editors);
                        }
                    }
                }

                var editors = allEditors
                    .DistinctBy(e => e.Id)
                    .Select(e => new EditorDto(e.Id, e.FirstName, e.LastName))
                    .ToList();

                return new PackageCardDto(
                    p.Id,
                    p.Title,
                    p.Description,
                    p.PublicationDate,
                    p.PlayedFrom,
                    p.PlayedTo,
                    p.QuestionsCount,
                    editors
                );
            })
            .ToList();
    }
}
