@page "/package/{Id:int}"
@attribute [StreamRendering]
@using Microsoft.EntityFrameworkCore
@using QuestionsHub.Blazor.Data
@using QuestionsHub.Blazor.Domain
@using QuestionsHub.Blazor.Infrastructure
@using QuestionsHub.Blazor.Utils
@inject QuestionsHubDbContext DbContext
@inject AccessControlService AccessControl

<PageTitle>@(_package?.Title ?? "–ü–∞–∫–µ—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ") - –ë–∞–∑–∞ —É–∫—Ä–∞—ó–Ω—Å—å–∫–∏—Ö –∑–∞–ø–∏—Ç–∞–Ω—å</PageTitle>

@if (_notFound)
{
    <div class="container mt-4">
        <div class="alert alert-warning">
            <h4>–ü–∞–∫–µ—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</h4>
            <p>–ü–∞–∫–µ—Ç –∑ —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä–æ–º @Id –Ω–µ —ñ—Å–Ω—É—î –∞–±–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π.</p>
            <a href="/" class="btn btn-primary">–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –Ω–∞ –≥–æ–ª–æ–≤–Ω—É</a>
        </div>
    </div>
}
else if (_package == null)
{
    <div class="container mt-4">
        <p><em>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</em></p>
    </div>
}
else
{
    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Left Sidebar Navigation -->
            <div class="col-md-3 col-lg-2 sidebar">
                <TourNavigation Package="_package" />
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 main-content">
                <div id="top">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h1 class="mb-0">@_package.Title</h1>
                        @if (_canEdit)
                        {
                            <a href="/manage/package/@_package.Id" class="btn btn-outline-primary btn-sm ms-3">
                                <i class="bi bi-pencil me-1"></i>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏
                            </a>
                        }
                    </div>

                    @if (!string.IsNullOrEmpty(_package.Description))
                    {
                        <p class="lead">@_package.Description</p>
                    }

                    @if (!string.IsNullOrEmpty(_package.Preamble))
                    {
                        <div class="preamble mb-3">
                            <p style="white-space: pre-line;">@_package.Preamble</p>
                        </div>
                    }

                    @if (_package.Editors.Any())
                    {
                        <p>
                            <strong>–†–µ–¥–∞–∫—Ç–æ—Ä–∏:</strong>
                            @{ var packageEditors = _package.Editors.ToList(); }
                            @for (var i = 0; i < packageEditors.Count; i++)
                            {
                                var editor = packageEditors[i];
                                @(" ")<a href="/editor/@editor.Id">@editor.FullName</a>@(i < packageEditors.Count - 1 ? "," : "")
                            }
                        </p>
                    }

                    @if (_package.Tags.Any())
                    {
                        <div class="d-flex flex-wrap gap-1 mb-3">
                            @foreach (var tag in _package.Tags)
                            {
                                <a href="/?tag=@tag.Id" class="badge rounded-pill bg-primary text-decoration-none">@tag.Name</a>
                            }
                        </div>
                    }

                    @{ var playedPeriod = PlayedPeriodFormatter.Format(_package.PlayedFrom, _package.PlayedTo); }
                    @if (!string.IsNullOrEmpty(playedPeriod))
                    {
                        <p>
                            <strong>–ó—ñ–≥—Ä–∞–Ω–æ:</strong> @playedPeriod
                        </p>
                    }

                    @if (_package.PublicationDate.HasValue)
                    {
                        <p>
                            <strong>–î–∞—Ç–∞ –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó:</strong> <span data-utc="@_package.PublicationDate.Value.ToString("o")"></span>
                        </p>
                    }
                </div>

                <div class="d-flex gap-2 mb-3">
                    <button class="btn btn-outline-secondary btn-sm" onclick="toggleAllAnswers(this)">
                        <Icon Name="eye" Class="toggle-all-icon me-1" /><span class="toggle-all-label">–ü–æ–∫–∞–∑–∞—Ç–∏ –≤—Å—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ</span>
                    </button>
                </div>

                @if (_isAdult)
                {
                    <div class="adult-package-banner" id="adult-banner" data-package-id="@_package.Id">
                        üîû –¶–µ–π –ø–∞–∫–µ—Ç –º—ñ—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç 18+.
                        <button class="btn btn-outline-dark btn-sm" onclick="revealAllAdultContent()">
                            –ú–µ–Ω—ñ —î 18 —Ä–æ–∫—ñ–≤, –ø–æ–∫–∞–∑–∞—Ç–∏ –≤–º—ñ—Å—Ç
                        </button>
                    </div>
                }

                <hr class="my-4" />

                @{
                    var blockNumberInPackage = 0;
                }
                @foreach (var tour in _package.Tours)
                {
                    <div id="tour-@tour.Id" class="tour-section">
                        <h2>
                            –¢—É—Ä @tour.Number
                        </h2>

                        @if (tour.HasBlocks)
                        {
                            @* Tour with blocks - display each block with its questions *@
                            @foreach (var block in tour.Blocks.OrderBy(b => b.OrderIndex))
                            {
                                blockNumberInPackage++;
                                <div id="block-@block.Id" class="block-section ms-3">
                                    <h4 class="block-header">
                                        @block.GetDisplayName(blockNumberInPackage)
                                    </h4>

                                    @if (block.Editors.Any())
                                    {
                                        <p>
                                            <small>
                                                <strong>–†–µ–¥–∞–∫—Ç–æ—Ä–∏ –±–ª–æ–∫—É:</strong>
                                                @for (var i = 0; i < block.Editors.Count; i++)
                                                {
                                                    var editor = block.Editors[i];
                                                    @(" ")<a href="/editor/@editor.Id">@editor.FullName</a>@(i < block.Editors.Count - 1 ? "," : "")
                                                }
                                            </small>
                                        </p>
                                    }

                                    @if (!string.IsNullOrEmpty(block.Preamble))
                                    {
                                        <div class="preamble mb-3">
                                            <p style="white-space: pre-line;">@block.Preamble</p>
                                        </div>
                                    }

                                    @foreach (var question in tour.Questions.Where(q => q.BlockId == block.Id).OrderBy(q => q.OrderIndex))
                                    {
                                        <div id="question-@question.Id">
                                            <QuestionCard Question="@question" IsBlurred="_isAdult" />
                                        </div>
                                    }
                                </div>
                            }

                            @* Display orphan questions (not assigned to any block) after all blocks *@
                            var orphanQuestions = tour.Questions.Where(q => q.BlockId == null).OrderBy(q => q.OrderIndex).ToList();
                            if (orphanQuestions.Any())
                            {
                                <div class="orphan-questions-section ms-3">
                                    @foreach (var question in orphanQuestions)
                                    {
                                        <div id="question-@question.Id">
                                            <QuestionCard Question="@question" IsBlurred="_isAdult" />
                                        </div>
                                    }
                                </div>
                            }
                        }
                        else
                        {
                            @* Tour without blocks - existing behavior *@
                            @if (tour.Editors.Any())
                            {
                                <p>
                                    <small>
                                        <strong>–†–µ–¥–∞–∫—Ç–æ—Ä–∏ —Ç—É—Ä—É:</strong>
                                        @for (var i = 0; i < tour.Editors.Count; i++)
                                        {
                                            var editor = tour.Editors[i];
                                            @(" ")<a href="/editor/@editor.Id">@editor.FullName</a>@(i < tour.Editors.Count - 1 ? "," : "")
                                        }
                                    </small>
                                </p>
                            }

                            @if (!string.IsNullOrEmpty(tour.Preamble))
                            {
                                <div class="preamble mb-3">
                                    <p style="white-space: pre-line;">@tour.Preamble</p>
                                </div>
                            }

                            @if (!string.IsNullOrEmpty(tour.Comment))
                            {
                                <p class="small">@tour.Comment</p>
                            }

                            @foreach (var question in tour.Questions.OrderBy(q => q.OrderIndex))
                            {
                                <div id="question-@question.Id">
                                    <QuestionCard Question="@question" IsBlurred="_isAdult" />
                                </div>
                            }
                        }
                    </div>
                }
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public int Id { get; set; }

    private Package? _package;
    private bool _notFound;
    private bool _canEdit;
    private bool _isAdult;

    protected override async Task OnInitializedAsync()
    {
        _package = await DbContext.Packages
            .AsNoTracking()
            .Include(p => p.PackageEditors)
            .Include(p => p.Tags)
            .Include(p => p.Tours)
                .ThenInclude(t => t.Editors)
            .Include(p => p.Tours)
                .ThenInclude(t => t.Blocks)
                    .ThenInclude(b => b.Editors)
            .Include(p => p.Tours)
                .ThenInclude(t => t.Questions)
                    .ThenInclude(q => q.Authors)
            .FirstOrDefaultAsync(p => p.Id == Id);

        if (_package == null)
        {
            _notFound = true;
            return;
        }

        // Check visibility based on package status and access level
        var accessContext = await AccessControl.GetPackageAccessContext();
        if (!accessContext.CanViewPackage(_package))
        {
            _package = null;
            _notFound = true;
            return;
        }

        // Check if the current user can edit the package
        _canEdit = await AccessControl.CanEditPackage(_package);

        // Check if the package has 18+ content tag
        _isAdult = TagService.IsAdultContent(_package.Tags);

        // Sort tours by Number, blocks by OrderIndex, and questions by OrderIndex
        _package.Tours = _package.Tours
            .OrderBy(t => int.TryParse(t.Number, out var num) ? num : int.MaxValue)
            .ThenBy(t => t.Number)
            .ToList();

        foreach (var tour in _package.Tours)
        {
            tour.Blocks = tour.Blocks
                .OrderBy(b => b.OrderIndex)
                .ToList();

            tour.Questions = tour.Questions
                .OrderBy(q => q.OrderIndex)
                .ToList();
        }
    }
}

