@page "/package/{Id:int}"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using QuestionsHub.Blazor.Data
@using QuestionsHub.Blazor.Domain
@using QuestionsHub.Blazor.Infrastructure
@inject QuestionsHubDbContext DbContext
@inject AccessControlService AccessControl

<PageTitle>@(_package?.Title ?? "Пакет не знайдено") - База українських запитань</PageTitle>

@if (_notFound)
{
    <div class="container mt-4">
        <div class="alert alert-warning">
            <h4>Пакет не знайдено</h4>
            <p>Пакет з ідентифікатором @Id не існує або недоступний.</p>
            <a href="/" class="btn btn-primary">Повернутися на головну</a>
        </div>
    </div>
}
else if (_package == null)
{
    <div class="container mt-4">
        <p><em>Завантаження...</em></p>
    </div>
}
else
{
    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Left Sidebar Navigation -->
            <div class="col-md-3 col-lg-2 sidebar">
                <TourNavigation Package="_package" />
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 main-content">
                <div id="top">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h1 class="mb-0">@_package.Title</h1>
                        @if (_canEdit)
                        {
                            <a href="/manage/package/@_package.Id" class="btn btn-outline-primary btn-sm ms-3">
                                <i class="bi bi-pencil me-1"></i>Редагувати
                            </a>
                        }
                    </div>

                    @if (!string.IsNullOrEmpty(_package.Description))
                    {
                        <p class="lead">@_package.Description</p>
                    }

                    @if (!string.IsNullOrEmpty(_package.Preamble))
                    {
                        <div class="preamble mb-3">
                            <p style="white-space: pre-line;">@_package.Preamble</p>
                        </div>
                    }

                    @if (_package.Editors.Any())
                    {
                        <p>
                            <strong>Редактори пакету:</strong>
                            @{ var packageEditors = _package.Editors.ToList(); }
                            @for (var i = 0; i < packageEditors.Count; i++)
                            {
                                var editor = packageEditors[i];
                                @(" ")<a href="/editor/@editor.Id">@editor.FullName</a>@(i < packageEditors.Count - 1 ? "," : "")
                            }
                        </p>
                    }

                    @if (_package.PlayedAt.HasValue)
                    {
                        <p>
                            <strong>Зіграно:</strong> @_package.PlayedAt.Value.ToString("MMMM yyyy")
                        </p>
                    }
                </div>

                <hr class="my-4" />

                @{
                    var blockNumberInPackage = 0;
                }
                @foreach (var tour in _package.Tours)
                {
                    <div id="tour-@tour.Id" class="tour-section">
                        <h2>
                            Тур @tour.Number
                        </h2>

                        @if (tour.HasBlocks)
                        {
                            @* Tour with blocks - display each block with its questions *@
                            @foreach (var block in tour.Blocks.OrderBy(b => b.OrderIndex))
                            {
                                blockNumberInPackage++;
                                <div id="block-@block.Id" class="block-section ms-3">
                                    <h4 class="block-header">
                                        @block.GetDisplayName(blockNumberInPackage)
                                    </h4>

                                    @if (block.Editors.Any())
                                    {
                                        <p>
                                            <small>
                                                <strong>Редактори блоку:</strong>
                                                @for (var i = 0; i < block.Editors.Count; i++)
                                                {
                                                    var editor = block.Editors[i];
                                                    @(" ")<a href="/editor/@editor.Id">@editor.FullName</a>@(i < block.Editors.Count - 1 ? "," : "")
                                                }
                                            </small>
                                        </p>
                                    }

                                    @if (!string.IsNullOrEmpty(block.Preamble))
                                    {
                                        <div class="preamble mb-3">
                                            <p style="white-space: pre-line;">@block.Preamble</p>
                                        </div>
                                    }

                                    @foreach (var question in tour.Questions.Where(q => q.BlockId == block.Id).OrderBy(q => q.OrderIndex))
                                    {
                                        <div id="question-@question.Id">
                                            <QuestionCard Question="@question" />
                                        </div>
                                    }
                                </div>
                            }
                        }
                        else
                        {
                            @* Tour without blocks - existing behavior *@
                            @if (tour.Editors.Any())
                            {
                                <p>
                                    <small>
                                        <strong>Редактори туру:</strong>
                                        @for (var i = 0; i < tour.Editors.Count; i++)
                                        {
                                            var editor = tour.Editors[i];
                                            @(" ")<a href="/editor/@editor.Id">@editor.FullName</a>@(i < tour.Editors.Count - 1 ? "," : "")
                                        }
                                    </small>
                                </p>
                            }

                            @if (!string.IsNullOrEmpty(tour.Preamble))
                            {
                                <div class="preamble mb-3">
                                    <p style="white-space: pre-line;">@tour.Preamble</p>
                                </div>
                            }

                            @if (!string.IsNullOrEmpty(tour.Comment))
                            {
                                <p class="small">@tour.Comment</p>
                            }

                            @foreach (var question in tour.Questions.OrderBy(q => q.OrderIndex))
                            {
                                <div id="question-@question.Id">
                                    <QuestionCard Question="@question" />
                                </div>
                            }
                        }
                    </div>
                }
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public int Id { get; set; }

    private Package? _package;
    private bool _notFound;
    private bool _canEdit;

    protected override async Task OnInitializedAsync()
    {
        _package = await DbContext.Packages
            .AsNoTracking()
            .Include(p => p.Tours)
                .ThenInclude(t => t.Editors)
            .Include(p => p.Tours)
                .ThenInclude(t => t.Blocks)
                    .ThenInclude(b => b.Editors)
            .Include(p => p.Tours)
                .ThenInclude(t => t.Questions)
                    .ThenInclude(q => q.Authors)
            .FirstOrDefaultAsync(p => p.Id == Id);

        if (_package == null)
        {
            _notFound = true;
            return;
        }

        // Check visibility based on package status
        var canView = await AccessControl.CanViewPackage(_package);
        if (!canView)
        {
            _package = null;
            _notFound = true;
            return;
        }

        // Check if the current user can edit the package
        _canEdit = await AccessControl.CanEditPackage(_package);

        // Sort tours by Number, blocks by OrderIndex, and questions by OrderIndex
        _package.Tours = _package.Tours
            .OrderBy(t => int.TryParse(t.Number, out var num) ? num : int.MaxValue)
            .ThenBy(t => t.Number)
            .ToList();

        foreach (var tour in _package.Tours)
        {
            tour.Blocks = tour.Blocks
                .OrderBy(b => b.OrderIndex)
                .ToList();

            tour.Questions = tour.Questions
                .OrderBy(q => q.OrderIndex)
                .ToList();
        }
    }
}

