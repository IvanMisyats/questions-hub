@page "/package/{Id:int}"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@using QuestionsHub.Blazor.Data
@using QuestionsHub.Blazor.Domain
@inject QuestionsHubDbContext DbContext

<PageTitle>@(_package?.Title ?? "Пакет не знайдено") - База українських запитань</PageTitle>

@if (_notFound)
{
    <div class="container mt-4">
        <div class="alert alert-warning">
            <h4>Пакет не знайдено</h4>
            <p>Пакет з ідентифікатором @Id не існує або недоступний.</p>
            <a href="/" class="btn btn-primary">Повернутися на головну</a>
        </div>
    </div>
}
else if (_package == null)
{
    <div class="container mt-4">
        <p><em>Завантаження...</em></p>
    </div>
}
else
{
    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Left Sidebar Navigation -->
            <div class="col-md-3 col-lg-2 sidebar">
                <TourNavigation Package="_package" />
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 main-content">
                <div id="top">
                    <h1>@_package.Title</h1>

                    @if (!string.IsNullOrEmpty(_package.Description))
                    {
                        <p class="lead">@_package.Description</p>
                    }

                    @if (_package.Editors.Any())
                    {
                        <p class="text-muted">
                            <strong>Редактори пакету:</strong> @string.Join(", ", _package.Editors)
                        </p>
                    }

                    @if (_package.PlayedAt.HasValue)
                    {
                        <p class="text-muted">
                            <strong>Зіграно:</strong> @_package.PlayedAt.Value.ToString("MMMM yyyy")
                        </p>
                    }
                </div>

                <hr class="my-4" />

                @foreach (var tour in _package.Tours)
                {
                    <div id="tour-@tour.Id" class="tour-section">
                        <h2>
                            Тур @tour.Number
                            @if (!string.IsNullOrEmpty(tour.Title))
                            {
                                <span>: @tour.Title</span>
                            }
                        </h2>

                        @if (tour.Editors.Any())
                        {
                            <p class="text-muted">
                                <small><strong>Редактори туру:</strong> @string.Join(", ", tour.Editors)</small>
                            </p>
                        }

                        @if (!string.IsNullOrEmpty(tour.Comment))
                        {
                            <p class="text-muted small">@tour.Comment</p>
                        }

                        @foreach (var question in tour.Questions)
                        {
                            <div id="question-@question.Id">
                                <QuestionCard Question="@question" />
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public int Id { get; set; }

    private Package? _package;
    private bool _notFound;

    [CascadingParameter]
    private Task<AuthenticationState>? AuthenticationState { get; set; }

    protected override async Task OnInitializedAsync()
    {
        _package = await DbContext.Packages
            .AsNoTracking()
            .Include(p => p.Tours)
            .ThenInclude(t => t.Questions)
            .FirstOrDefaultAsync(p => p.Id == Id);

        if (_package == null)
        {
            _notFound = true;
            return;
        }

        // Check visibility based on package status
        var canView = await CanViewPackageAsync(_package);
        if (!canView)
        {
            _package = null;
            _notFound = true;
            return;
        }

        // Sort tours by Number and questions by OrderIndex
        _package.Tours = _package.Tours
            .OrderBy(t => int.TryParse(t.Number, out var num) ? num : int.MaxValue)
            .ThenBy(t => t.Number)
            .ToList();

        foreach (var tour in _package.Tours)
        {
            tour.Questions = tour.Questions
                .OrderBy(q => q.OrderIndex)
                .ToList();
        }
    }

    private async Task<bool> CanViewPackageAsync(Package package)
    {
        // Published packages are visible to everyone
        if (package.Status == PackageStatus.Published)
            return true;

        // Archived packages are accessible via direct link
        if (package.Status == PackageStatus.Archived)
            return true;

        // Draft packages require authentication
        if (AuthenticationState == null)
            return false;

        var authState = await AuthenticationState;
        var user = authState.User;

        if (!user.Identity?.IsAuthenticated ?? true)
            return false;

        // Admins can see all packages
        if (user.IsInRole("Admin"))
            return true;

        // Owners can see their own draft packages
        var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        return package.OwnerId == userId;
    }
}

