@page "/manage/package/{Id:int?}"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@using QuestionsHub.Blazor.Domain
@using QuestionsHub.Blazor.Infrastructure
@attribute [Authorize(Roles = "Editor,Admin")]

@inject IDbContextFactory<QuestionsHubDbContext> DbContextFactory
@inject NavigationManager Navigation
@inject MediaService MediaService
@inject AuthorService AuthorService

<PageTitle>@(_package?.Title ?? "Новий пакет") - QuestionsHub</PageTitle>

<div class="container py-4">
    @if (_isLoading)
    {
        <div class="d-flex justify-content-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Завантаження...</span>
            </div>
        </div>
    }
    else if (_errorMessage != null)
    {
        <div class="alert alert-danger" role="alert">
            <i class="bi bi-exclamation-triangle me-2"></i>@_errorMessage
        </div>
        <a href="/manage/packages" class="btn btn-secondary">Повернутися до списку</a>
    }
    else if (_package != null)
    {
        <div class="d-flex justify-content-between align-items-center mb-4">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="/manage/packages">Мої пакети</a></li>
                    <li class="breadcrumb-item active" aria-current="page">@_package.Title</li>
                </ol>
            </nav>
            <div>
                @if (_saveStatus != null)
                {
                    <span class="text-muted me-3">
                        <i class="bi @(_isSaving ? "bi-arrow-repeat" : "bi-check-circle") me-1"></i>
                        @_saveStatus
                    </span>
                }
            </div>
        </div>

        <!-- Package Details Section -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Інформація про пакет</h5>
                <span class="badge @GetStatusBadgeClass(_package.Status)">@GetStatusDisplayName(_package.Status)</span>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-8">
                        <label for="packageTitle" class="form-label">Назва пакету</label>
                        <input type="text" class="form-control" id="packageTitle"
                               @bind="_package.Title" @onblur="SavePackageAsync" />
                    </div>
                    <div class="col-md-4">
                        <label for="packagePlayedAt" class="form-label">Дата проведення</label>
                        <input type="date" class="form-control" id="packagePlayedAt" lang="uk"
                               value="@(_package.PlayedAt?.ToString("yyyy-MM-dd"))"
                               @onchange="OnPlayedAtChanged" @onblur="SavePackageAsync" />
                    </div>
                    <div class="col-12">
                        <label for="packageDescription" class="form-label">Опис</label>
                        <textarea class="form-control auto-expand" id="packageDescription"
                                  @bind="_package.Description" @onblur="SavePackageAsync"></textarea>
                    </div>
                    <div class="col-12">
                        <label for="packagePreamble" class="form-label">Преамбула</label>
                        <textarea class="form-control auto-expand" id="packagePreamble"
                                  @bind="_package.Preamble" @onblur="SavePackageAsync"
                                  placeholder="Інформація від редактора, подяки тестерам тощо"></textarea>
                    </div>
                    <div class="col-md-4">
                        <label for="packageStatus" class="form-label">Статус</label>
                        <select class="form-select" id="packageStatus"
                                @bind="_package.Status" @onblur="SavePackageAsync">
                            <option value="@PackageStatus.Draft">Чернетка</option>
                            <option value="@PackageStatus.Published">Опубліковано</option>
                            <option value="@PackageStatus.Archived">Архів</option>
                        </select>
                    </div>
                    @if (_package.Editors.Any())
                    {
                        <div class="col-12">
                            <label class="form-label">Редактори пакету</label>
                            <div class="text-muted small">
                                @string.Join(", ", _package.Editors.Select(e => e.FullName))
                                <span class="text-muted ms-2">(визначаються з турів)</span>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Tours Section -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Тури <span class="badge bg-secondary ms-2">@_package.Tours.Count</span></h5>
                <button class="btn btn-success btn-sm" @onclick="AddTourAsync">
                    <i class="bi bi-plus-lg me-1"></i>Додати тур
                </button>
            </div>
            <div class="card-body">
                @if (_package.Tours.Count == 0)
                {
                    <div class="text-center py-4 text-muted">
                        <i class="bi bi-collection fs-1 d-block mb-2"></i>
                        <p>Пакет ще не має турів. Натисніть "Додати тур", щоб почати.</p>
                    </div>
                }
                else
                {
                    <div class="accordion" id="toursAccordion">
                        @foreach (var tour in _package.Tours.OrderBy(t => t.Number))
                        {
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button @(IsExpanded(tour.Id) ? "" : "collapsed")" type="button"
                                            @onclick="() => ToggleExpand(tour.Id)">
                                        <span class="me-2">
                                            <strong>Тур @tour.Number</strong>
                                        </span>
                                        <span class="badge bg-info ms-auto me-2">@tour.Questions.Count питань</span>
                                    </button>
                                </h2>
                                <div class="accordion-collapse collapse @(IsExpanded(tour.Id) ? "show" : "")"
                                     id="tour-@tour.Id">
                                    <div class="accordion-body">
                                        <!-- Tour Edit Controls -->
                                        <div class="row g-2 mb-3 pb-3 border-bottom">
                                            <div class="col-md-2">
                                                <label class="form-label small">Номер</label>
                                                <input type="text" class="form-control form-control-sm"
                                                       @bind="tour.Number" @onblur="() => SaveTourAsync(tour)" />
                                            </div>
                                            <div class="col-md-8">
                                                <label class="form-label small">Редактори туру</label>
                                                <AuthorSelector SelectedAuthors="tour.Editors"
                                                                OnSelectionChanged="() => SaveTourAsync(tour)"
                                                                OnAuthorRemoved="TryDeleteOrphanedAuthorAsync"
                                                                Placeholder="Введіть прізвище редактора..." />
                                            </div>
                                            <div class="col-md-2 d-flex align-items-end">
                                                <button class="btn btn-outline-danger btn-sm w-100"
                                                        @onclick="() => ConfirmDeleteTour(tour)">
                                                    <i class="bi bi-trash"></i> Видалити
                                                </button>
                                            </div>
                                            <div class="col-12">
                                                <label class="form-label small">Преамбула</label>
                                                <textarea class="form-control form-control-sm auto-expand"
                                                          @bind="tour.Preamble" @onblur="() => SaveTourAsync(tour)"
                                                          placeholder="Інформація від редактора, подяки тестерам тощо"></textarea>
                                            </div>
                                        </div>

                                        <!-- Questions List -->
                                        @if (tour.Questions.Count == 0)
                                        {
                                            <div class="text-center py-3 text-muted">
                                                <p class="mb-2">Тур ще не має питань.</p>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="list-group mb-3">
                                                @foreach (var question in tour.Questions.OrderBy(q => q.OrderIndex))
                                                {
                                                    <div class="list-group-item list-group-item-action d-flex align-items-center gap-2">
                                                        <span class="badge bg-primary flex-shrink-0">@question.Number</span>
                                                        <div class="flex-grow-1" style="cursor: pointer;"
                                                             @onclick="() => OpenQuestionEditor(tour, question)">
                                                            @question.Text
                                                        </div>
                                                        <button class="btn btn-danger flex-shrink-0 d-flex align-items-center justify-content-center"
                                                                style="width: 24px; height: 24px; padding: 0; font-size: 1.25rem; line-height: 1;"
                                                                @onclick="() => ConfirmDeleteQuestion(tour, question)"
                                                                @onclick:stopPropagation="true"
                                                                title="Видалити">×</button>
                                                    </div>
                                                }
                                            </div>
                                        }

                                        <button class="btn btn-outline-success btn-sm"
                                                @onclick="() => AddQuestionAsync(tour)">
                                            <i class="bi bi-plus-lg me-1"></i>Додати питання
                                        </button>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    <div class="mt-3 text-center">
                        <button class="btn btn-success" @onclick="AddTourAsync">
                            <i class="bi bi-plus-lg me-1"></i>Додати тур
                        </button>
                    </div>
                }
            </div>
        </div>
    }
</div>

<!-- Delete Tour Modal -->
@if (_showDeleteTourModal && _tourToDelete != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Видалити тур</h5>
                    <button type="button" class="btn-close" @onclick="CancelDeleteTour"></button>
                </div>
                <div class="modal-body">
                    <p>Ви впевнені, що хочете видалити <strong>Тур @_tourToDelete.Number</strong>?</p>
                    <p class="text-danger mb-0">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Всі @_tourToDelete.Questions.Count питань туру будуть видалені.
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CancelDeleteTour">Скасувати</button>
                    <button type="button" class="btn btn-danger" @onclick="DeleteTourAsync">Видалити</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Delete Question Modal -->
@if (_showDeleteQuestionModal && _questionToDelete != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Видалити питання</h5>
                    <button type="button" class="btn-close" @onclick="CancelDeleteQuestion"></button>
                </div>
                <div class="modal-body">
                    <p>Ви впевнені, що хочете видалити <strong>Питання @_questionToDelete.Number</strong>?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CancelDeleteQuestion">Скасувати</button>
                    <button type="button" class="btn btn-danger" @onclick="DeleteQuestionAsync">Видалити</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Question Editor Modal -->
@if (_showQuestionEditor && _editingQuestion != null && _editingTour != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-xl modal-dialog-scrollable modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        Питання @_editingQuestion.Number
                        <span class="text-muted">(Тур @_editingTour.Number)</span>
                    </h5>
                    <div class="ms-auto me-3">
                        <button class="btn btn-outline-secondary btn-sm me-1"
                                @onclick="NavigateToPrevQuestion"
                                disabled="@(!CanNavigatePrev())">
                            <i class="bi bi-chevron-left"></i> Попереднє
                        </button>
                        <button class="btn btn-outline-secondary btn-sm"
                                @onclick="NavigateToNextQuestion"
                                disabled="@(!CanNavigateNext())">
                            Наступне <i class="bi bi-chevron-right"></i>
                        </button>
                        @if (!CanNavigateNext())
                        {
                            <button class="btn btn-outline-success btn-sm ms-1"
                                    @onclick="CreateAndNavigateToNextQuestion"
                                    title="Створити нове питання в цьому турі">
                                <i class="bi bi-plus-lg"></i> Створити наступне
                            </button>
                        }
                    </div>
                    <button type="button" class="btn-close" @onclick="CloseQuestionEditor"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-2">
                        <div class="col-md-2">
                            <label class="col-form-label">Номер</label>
                        </div>
                        <div class="col-md-10">
                            <input type="text" class="form-control" style="max-width: 100px;"
                                   @bind="_editingQuestion.Number" @onblur="SaveEditingQuestionAsync" />
                        </div>
                        <div class="col-md-2">
                            <label class="col-form-label">Вказівка ведучому</label>
                        </div>
                        <div class="col-md-10">
                            <textarea class="form-control auto-expand" placeholder="Інструкції для ведучого/організатора"
                                      @bind="_editingQuestion.HostInstructions" @onblur="SaveEditingQuestionAsync"></textarea>
                        </div>
                        <div class="col-md-2">
                            <label class="col-form-label">Роздатковий матеріал</label>
                        </div>
                        <div class="col-md-10">
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <textarea class="form-control auto-expand" placeholder="Текст роздавального матеріалу"
                                              @bind="_editingQuestion.HandoutText" @onblur="SaveEditingQuestionAsync"></textarea>
                                </div>
                                <div class="col-md-6">
                                    @if (!string.IsNullOrEmpty(_editingQuestion.HandoutUrl))
                                    {
                                        <div class="mb-2 p-2 border rounded bg-light">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <a href="@_editingQuestion.HandoutUrl" target="_blank" class="text-truncate small">
                                                    <i class="bi bi-box-arrow-up-right me-1"></i>@GetFileName(_editingQuestion.HandoutUrl)
                                                </a>
                                                <button type="button" class="btn btn-danger btn-sm"
                                                        @onclick="DeleteHandoutMediaAsync"
                                                        disabled="@_isUploadingHandout">
                                                    <i class="bi bi-trash me-1"></i>Видалити
                                                </button>
                                            </div>
                                            @{
                                                var handoutMediaType = MediaSecurityOptions.GetMediaType(_editingQuestion.HandoutUrl);
                                            }
                                            @switch (handoutMediaType)
                                            {
                                                case MediaType.Image:
                                                    <img src="@_editingQuestion.HandoutUrl" alt="Роздатковий матеріал"
                                                         class="img-fluid rounded" style="max-height: 200px;" />
                                                    break;
                                                case MediaType.Video:
                                                    <video controls class="rounded" style="max-width: 100%; max-height: 200px;">
                                                        <source src="@_editingQuestion.HandoutUrl"
                                                                type="@MediaSecurityOptions.GetContentTypeFromPath(_editingQuestion.HandoutUrl)" />
                                                        Ваш браузер не підтримує відтворення відео.
                                                    </video>
                                                    break;
                                                case MediaType.Audio:
                                                    <audio controls style="width: 100%; max-width: 400px;">
                                                        <source src="@_editingQuestion.HandoutUrl"
                                                                type="@MediaSecurityOptions.GetContentTypeFromPath(_editingQuestion.HandoutUrl)" />
                                                        Ваш браузер не підтримує відтворення аудіо.
                                                    </audio>
                                                    break;
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="input-group" @key="_handoutInputKey">
                                            <InputFile class="form-control"
                                                       OnChange="OnHandoutFileSelected"
                                                       accept=".jpg,.jpeg,.png,.gif,.webp,.mp4,.webm,.mp3,.ogg,.wav"
                                                       disabled="@_isUploadingHandout" />
                                            @if (_isUploadingHandout)
                                            {
                                                <span class="input-group-text">
                                                    <span class="spinner-border spinner-border-sm" role="status"></span>
                                                </span>
                                            }
                                        </div>
                                    }
                                    @if (!string.IsNullOrEmpty(_handoutUploadError))
                                    {
                                        <div class="text-danger small mt-1">
                                            <i class="bi bi-exclamation-circle me-1"></i>@_handoutUploadError
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label class="col-form-label">Текст питання <span class="text-danger">*</span></label>
                        </div>
                        <div class="col-md-10">
                            <textarea class="form-control auto-expand"
                                      @bind="_editingQuestion.Text" @onblur="SaveEditingQuestionAsync"></textarea>
                        </div>
                        <div class="col-md-2">
                            <label class="col-form-label">Відповідь <span class="text-danger">*</span></label>
                        </div>
                        <div class="col-md-10">
                            <input type="text" class="form-control"
                                   @bind="_editingQuestion.Answer" @onblur="SaveEditingQuestionAsync" />
                        </div>
                        <div class="col-md-2">
                            <label class="col-form-label">Залік</label>
                        </div>
                        <div class="col-md-5">
                            <input type="text" class="form-control" placeholder="альтернативні відповіді"
                                   @bind="_editingQuestion.AcceptedAnswers" @onblur="SaveEditingQuestionAsync" />
                        </div>
                        <div class="col-md-2 text-end">
                            <label class="col-form-label">Незалік</label>
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control"
                                   @bind="_editingQuestion.RejectedAnswers" @onblur="SaveEditingQuestionAsync" />
                        </div>
                        <div class="col-md-2">
                            <label class="col-form-label">Коментар</label>
                        </div>
                        <div class="col-md-10">
                            <textarea class="form-control auto-expand"
                                      @bind="_editingQuestion.Comment" @onblur="SaveEditingQuestionAsync"></textarea>
                        </div>
                        <div class="col-md-2">
                            <label class="col-form-label">Ілюстрація</label>
                        </div>
                        <div class="col-md-10">
                            @if (!string.IsNullOrEmpty(_editingQuestion.CommentAttachmentUrl))
                            {
                                <div class="mb-2 p-2 border rounded bg-light">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <a href="@_editingQuestion.CommentAttachmentUrl" target="_blank" class="text-truncate small">
                                            <i class="bi bi-box-arrow-up-right me-1"></i>@GetFileName(_editingQuestion.CommentAttachmentUrl)
                                        </a>
                                        <button type="button" class="btn btn-danger btn-sm"
                                                @onclick="DeleteCommentMediaAsync"
                                                disabled="@_isUploadingComment">
                                            <i class="bi bi-trash me-1"></i>Видалити
                                        </button>
                                    </div>
                                    @{
                                        var commentMediaType = MediaSecurityOptions.GetMediaType(_editingQuestion.CommentAttachmentUrl);
                                    }
                                    @switch (commentMediaType)
                                    {
                                        case MediaType.Image:
                                            <img src="@_editingQuestion.CommentAttachmentUrl" alt="Ілюстрація до коментаря"
                                                 class="img-fluid rounded" style="max-height: 200px;" />
                                            break;
                                        case MediaType.Video:
                                            <video controls class="rounded" style="max-width: 100%; max-height: 200px;">
                                                <source src="@_editingQuestion.CommentAttachmentUrl"
                                                        type="@MediaSecurityOptions.GetContentTypeFromPath(_editingQuestion.CommentAttachmentUrl)" />
                                                Ваш браузер не підтримує відтворення відео.
                                            </video>
                                            break;
                                        case MediaType.Audio:
                                            <audio controls style="width: 100%; max-width: 400px;">
                                                <source src="@_editingQuestion.CommentAttachmentUrl"
                                                        type="@MediaSecurityOptions.GetContentTypeFromPath(_editingQuestion.CommentAttachmentUrl)" />
                                                Ваш браузер не підтримує відтворення аудіо.
                                            </audio>
                                            break;
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="input-group" @key="_commentInputKey">
                                    <InputFile class="form-control"
                                               OnChange="OnCommentFileSelected"
                                               accept=".jpg,.jpeg,.png,.gif,.webp,.mp4,.webm,.mp3,.ogg,.wav"
                                               disabled="@_isUploadingComment" />
                                    @if (_isUploadingComment)
                                    {
                                        <span class="input-group-text">
                                            <span class="spinner-border spinner-border-sm" role="status"></span>
                                        </span>
                                    }
                                </div>
                            }
                            @if (!string.IsNullOrEmpty(_commentUploadError))
                            {
                                <div class="text-danger small mt-1">
                                    <i class="bi bi-exclamation-circle me-1"></i>@_commentUploadError
                                </div>
                            }
                        </div>
                        <div class="col-md-2">
                            <label class="col-form-label">Джерело</label>
                        </div>
                        <div class="col-md-10">
                            <textarea class="form-control auto-expand" placeholder="Джерела інформації (кожне з нового рядка)"
                                      @bind="_editingQuestion.Source" @onblur="SaveEditingQuestionAsync"></textarea>
                        </div>
                        <div class="col-md-2">
                            <label class="col-form-label">Автори</label>
                        </div>
                        <div class="col-md-10">
                            <AuthorSelector SelectedAuthors="_editingQuestion.Authors"
                                            OnSelectionChanged="SaveEditingQuestionAsync"
                                            OnAuthorRemoved="TryDeleteOrphanedAuthorAsync"
                                            Placeholder="Введіть прізвище автора..." />
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    @if (_questionSaveStatus != null)
                    {
                        <span class="text-muted me-auto">
                            <i class="bi bi-check-circle me-1"></i>@_questionSaveStatus
                        </span>
                    }
                    <button type="button" class="btn btn-secondary" @onclick="CloseQuestionEditor">Закрити</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public int? Id { get; set; }

    private Package? _package;
    private bool _isLoading = true;
    private string? _errorMessage;
    private string? _userId;
    private bool _isAdmin;
    private bool _isSaving;
    private string? _saveStatus;

    // Accordion state
    private HashSet<int> _expandedTours = new();

    // Delete tour modal
    private bool _showDeleteTourModal;
    private Tour? _tourToDelete;

    // Delete question modal
    private bool _showDeleteQuestionModal;
    private Question? _questionToDelete;
    private Tour? _questionToDeleteTour;

    // Question editor modal
    private bool _showQuestionEditor;
    private Question? _editingQuestion;
    private Tour? _editingTour;
    private string? _questionSaveStatus;

    // Media upload state
    private bool _isUploadingHandout;
    private bool _isUploadingComment;
    private string? _handoutUploadError;
    private string? _commentUploadError;
    private const long MaxUploadSize = 100 * 1024 * 1024; // 100 MB max for streaming
    private Guid _handoutInputKey = Guid.NewGuid();
    private Guid _commentInputKey = Guid.NewGuid();

    [CascadingParameter]
    private Task<AuthenticationState>? AuthenticationState { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await CheckUserAsync();
        await LoadPackageAsync();
    }

    private async Task CheckUserAsync()
    {
        if (AuthenticationState != null)
        {
            var authState = await AuthenticationState;
            _isAdmin = authState.User.IsInRole("Admin");
            _userId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        }
    }

    private async Task LoadPackageAsync()
    {
        _isLoading = true;
        _errorMessage = null;

        try
        {
            if (Id == null)
            {
                // Create new package
                await using var context = await DbContextFactory.CreateDbContextAsync();
                _package = new Package
                {
                    Title = "Новий пакет",
                    Description = null,
                    PlayedAt = null,
                    Status = PackageStatus.Draft,
                    OwnerId = _userId,
                    TotalQuestions = 0,
                    Tours = new List<Tour>()
                };

                context.Packages.Add(_package);
                await context.SaveChangesAsync();

                // Redirect to the new package's URL
                Navigation.NavigateTo($"/manage/package/{_package.Id}", replace: true);
            }
            else
            {
                await using var context = await DbContextFactory.CreateDbContextAsync();
                _package = await context.Packages
                    .Include(p => p.Tours)
                        .ThenInclude(t => t.Editors)
                    .Include(p => p.Tours)
                        .ThenInclude(t => t.Questions)
                            .ThenInclude(q => q.Authors)
                    .FirstOrDefaultAsync(p => p.Id == Id);

                if (_package == null)
                {
                    _errorMessage = "Пакет не знайдено.";
                }
                else if (!_isAdmin && _package.OwnerId != _userId)
                {
                    _errorMessage = "Ви не маєте доступу до цього пакету.";
                    _package = null;
                }
                else
                {
                    // Expand first tour by default
                    if (_package.Tours.Count > 0)
                    {
                        _expandedTours.Add(_package.Tours.First().Id);
                    }
                }
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Помилка завантаження: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task SavePackageAsync()
    {
        if (_package == null) return;

        _isSaving = true;
        _saveStatus = "Збереження...";
        StateHasChanged();

        try
        {
            // Trim whitespaces from text fields
            _package.Title = _package.Title.Trim();
            _package.Description = _package.Description?.Trim();
            _package.Preamble = _package.Preamble?.Trim();

            await using var context = await DbContextFactory.CreateDbContextAsync();
            var dbPackage = await context.Packages.FindAsync(_package.Id);
            if (dbPackage != null)
            {
                dbPackage.Title = _package.Title;
                dbPackage.Description = _package.Description;
                dbPackage.Preamble = _package.Preamble;
                dbPackage.PlayedAt = _package.PlayedAt;
                dbPackage.Status = _package.Status;
                await context.SaveChangesAsync();
            }
            _saveStatus = "Збережено";
        }
        catch
        {
            _saveStatus = "Помилка збереження";
        }
        finally
        {
            _isSaving = false;
            StateHasChanged();
        }
    }

    private void OnPlayedAtChanged(ChangeEventArgs e)
    {
        if (DateOnly.TryParse(e.Value?.ToString(), out var date))
        {
            _package!.PlayedAt = date;
        }
        else
        {
            _package!.PlayedAt = null;
        }
    }

    private async Task SaveTourAsync(Tour tour)
    {
        _saveStatus = "Збереження туру...";
        StateHasChanged();

        try
        {
            // Trim whitespaces from text fields
            tour.Number = tour.Number.Trim();
            tour.Preamble = tour.Preamble?.Trim();
            tour.Comment = tour.Comment?.Trim();

            await using var context = await DbContextFactory.CreateDbContextAsync();
            var dbTour = await context.Tours
                .Include(t => t.Editors)
                .FirstOrDefaultAsync(t => t.Id == tour.Id);
            if (dbTour != null)
            {
                dbTour.Number = tour.Number;
                dbTour.Preamble = tour.Preamble;
                dbTour.Comment = tour.Comment;

                // Update editors (many-to-many)
                dbTour.Editors.Clear();
                foreach (var editor in tour.Editors)
                {
                    var dbAuthor = await context.Authors.FindAsync(editor.Id);
                    if (dbAuthor != null)
                    {
                        dbTour.Editors.Add(dbAuthor);
                    }
                }

                await context.SaveChangesAsync();
            }
            _saveStatus = "Збережено";
        }
        catch
        {
            _saveStatus = "Помилка збереження";
        }
        StateHasChanged();
    }

    private async Task AddTourAsync()
    {
        if (_package == null) return;

        try
        {
            await using var context = await DbContextFactory.CreateDbContextAsync();

            // Auto-increment from the highest existing tour number
            var maxNumber = _package.Tours
                .Select(t => int.TryParse(t.Number, out var n) ? n : 0)
                .DefaultIfEmpty(0)
                .Max();
            var newNumber = (maxNumber + 1).ToString();

            var tour = new Tour
            {
                PackageId = _package.Id,
                Number = newNumber,
                Editors = new List<Author>(),
                Preamble = null,
                Comment = null,
                Questions = new List<Question>()
            };

            context.Tours.Add(tour);
            await context.SaveChangesAsync();

            _package.Tours.Add(tour);
            _expandedTours.Add(tour.Id);
            _saveStatus = "Тур додано";
        }
        catch (Exception ex)
        {
            _saveStatus = $"Помилка: {ex.Message}";
        }
        StateHasChanged();
    }

    private void ConfirmDeleteTour(Tour tour)
    {
        _tourToDelete = tour;
        _showDeleteTourModal = true;
    }

    private void CancelDeleteTour()
    {
        _tourToDelete = null;
        _showDeleteTourModal = false;
    }

    private async Task DeleteTourAsync()
    {
        if (_tourToDelete == null || _package == null) return;

        try
        {
            await using var context = await DbContextFactory.CreateDbContextAsync();
            var dbTour = await context.Tours
                .Include(t => t.Questions)
                .FirstOrDefaultAsync(t => t.Id == _tourToDelete.Id);

            if (dbTour != null)
            {
                // Update package total questions
                var dbPackage = await context.Packages.FindAsync(_package.Id);
                if (dbPackage != null)
                {
                    dbPackage.TotalQuestions -= dbTour.Questions.Count;
                }

                context.Tours.Remove(dbTour);
                await context.SaveChangesAsync();

                _package.Tours.Remove(_tourToDelete);
                _package.TotalQuestions -= _tourToDelete.Questions.Count;
            }

            _showDeleteTourModal = false;
            _tourToDelete = null;
            _saveStatus = "Тур видалено";
        }
        catch (Exception ex)
        {
            _saveStatus = $"Помилка: {ex.Message}";
        }
        StateHasChanged();
    }

    private async Task AddQuestionAsync(Tour tour)
    {
        if (_package == null) return;

        var question = await CreateQuestionAsync(tour);
        if (question != null)
        {
            OpenQuestionEditor(tour, question);
        }
        StateHasChanged();
    }

    private string CalculateNextQuestionNumber(int fallbackOrderIndex)
    {
        if (_package == null) return (fallbackOrderIndex + 1).ToString();

        // Find the last question across all tours (by tour order, then question order)
        var lastQuestion = _package.Tours
            .OrderBy(t => t.Number)
            .SelectMany(t => t.Questions.OrderBy(q => q.OrderIndex))
            .LastOrDefault();

        if (lastQuestion != null && int.TryParse(lastQuestion.Number, out var lastNum))
        {
            return (lastNum + 1).ToString();
        }

        // Fallback to 1-based index within the tour
        return (fallbackOrderIndex + 1).ToString();
    }

    private async Task<Question?> CreateQuestionAsync(Tour tour)
    {
        if (_package == null) return null;

        try
        {
            await using var context = await DbContextFactory.CreateDbContextAsync();

            var newOrderIndex = tour.Questions.Count;
            var newNumber = CalculateNextQuestionNumber(newOrderIndex);

            var question = new Question
            {
                TourId = tour.Id,
                OrderIndex = newOrderIndex,
                Number = newNumber,
                Text = "",
                Answer = "",
                Authors = tour.Editors.Select(e => new Author
                {
                    Id = e.Id,
                    FirstName = e.FirstName,
                    LastName = e.LastName
                }).ToList()
            };

            context.Questions.Add(question);

            foreach (var author in question.Authors)
            {
                context.Authors.Attach(author);
            }

            var dbPackage = await context.Packages.FindAsync(_package.Id);
            if (dbPackage != null)
            {
                dbPackage.TotalQuestions++;
            }

            await context.SaveChangesAsync();

            tour.Questions.Add(question);
            _package.TotalQuestions++;

            _saveStatus = "Питання додано";
            return question;
        }
        catch (Exception ex)
        {
            _saveStatus = $"Помилка: {ex.Message}";
            return null;
        }
    }

    private void ConfirmDeleteQuestion(Tour tour, Question question)
    {
        _questionToDelete = question;
        _questionToDeleteTour = tour;
        _showDeleteQuestionModal = true;
    }

    private void CancelDeleteQuestion()
    {
        _questionToDelete = null;
        _questionToDeleteTour = null;
        _showDeleteQuestionModal = false;
    }

    private async Task DeleteQuestionAsync()
    {
        if (_questionToDelete == null || _questionToDeleteTour == null || _package == null) return;

        try
        {
            await using var context = await DbContextFactory.CreateDbContextAsync();
            var dbQuestion = await context.Questions.FindAsync(_questionToDelete.Id);

            if (dbQuestion != null)
            {
                // Update package total
                var dbPackage = await context.Packages.FindAsync(_package.Id);
                if (dbPackage != null)
                {
                    dbPackage.TotalQuestions--;
                }

                context.Questions.Remove(dbQuestion);
                await context.SaveChangesAsync();

                _questionToDeleteTour.Questions.Remove(_questionToDelete);
                _package.TotalQuestions--;
            }

            _showDeleteQuestionModal = false;
            _questionToDelete = null;
            _questionToDeleteTour = null;
            _saveStatus = "Питання видалено";
        }
        catch (Exception ex)
        {
            _saveStatus = $"Помилка: {ex.Message}";
        }
        StateHasChanged();
    }

    private void OpenQuestionEditor(Tour tour, Question question)
    {
        _editingTour = tour;
        _editingQuestion = question;
        _showQuestionEditor = true;
        _questionSaveStatus = null;
        ResetMediaInputState();
    }

    private void CloseQuestionEditor()
    {
        _editingTour = null;
        _editingQuestion = null;
        _showQuestionEditor = false;
        _questionSaveStatus = null;
    }

    private async Task SaveEditingQuestionAsync()
    {
        if (_editingQuestion == null) return;

        try
        {
            // Trim whitespaces from text fields
            _editingQuestion.Number = _editingQuestion.Number.Trim();
            _editingQuestion.Text = _editingQuestion.Text.Trim();
            _editingQuestion.Answer = _editingQuestion.Answer.Trim();
            _editingQuestion.HostInstructions = _editingQuestion.HostInstructions?.Trim();
            _editingQuestion.HandoutText = _editingQuestion.HandoutText?.Trim();
            _editingQuestion.AcceptedAnswers = _editingQuestion.AcceptedAnswers?.Trim();
            _editingQuestion.RejectedAnswers = _editingQuestion.RejectedAnswers?.Trim();
            _editingQuestion.Comment = _editingQuestion.Comment?.Trim();
            _editingQuestion.Source = _editingQuestion.Source?.Trim();

            await using var context = await DbContextFactory.CreateDbContextAsync();
            var dbQuestion = await context.Questions
                .Include(q => q.Authors)
                .FirstOrDefaultAsync(q => q.Id == _editingQuestion.Id);
            if (dbQuestion != null)
            {
                dbQuestion.Number = _editingQuestion.Number;
                dbQuestion.Text = _editingQuestion.Text;
                dbQuestion.Answer = _editingQuestion.Answer;
                dbQuestion.HostInstructions = _editingQuestion.HostInstructions;
                dbQuestion.HandoutText = _editingQuestion.HandoutText;
                dbQuestion.AcceptedAnswers = _editingQuestion.AcceptedAnswers;
                dbQuestion.RejectedAnswers = _editingQuestion.RejectedAnswers;
                dbQuestion.Comment = _editingQuestion.Comment;
                dbQuestion.Source = _editingQuestion.Source;

                // Update authors (many-to-many)
                dbQuestion.Authors.Clear();
                foreach (var author in _editingQuestion.Authors)
                {
                    var dbAuthor = await context.Authors.FindAsync(author.Id);
                    if (dbAuthor != null)
                    {
                        dbQuestion.Authors.Add(dbAuthor);
                    }
                }

                await context.SaveChangesAsync();
            }
            _questionSaveStatus = "Збережено";
        }
        catch
        {
            _questionSaveStatus = "Помилка збереження";
        }
        StateHasChanged();
    }


    private bool CanNavigatePrev()
    {
        if (_editingQuestion == null || _editingTour == null || _package == null) return false;

        var orderedQuestions = _editingTour.Questions.OrderBy(q => q.OrderIndex).ToList();
        var currentIndex = orderedQuestions.IndexOf(_editingQuestion);

        // Can navigate prev if not first question, or if there's a previous tour
        if (currentIndex > 0) return true;

        var orderedTours = _package.Tours.OrderBy(t => t.Number).ToList();
        var tourIndex = orderedTours.IndexOf(_editingTour);
        return tourIndex > 0 && orderedTours[tourIndex - 1].Questions.Count > 0;
    }

    private bool CanNavigateNext()
    {
        if (_editingQuestion == null || _editingTour == null || _package == null) return false;

        var orderedQuestions = _editingTour.Questions.OrderBy(q => q.OrderIndex).ToList();
        var currentIndex = orderedQuestions.IndexOf(_editingQuestion);

        // Can navigate next if not last question, or if there's a next tour
        if (currentIndex < orderedQuestions.Count - 1) return true;

        var orderedTours = _package.Tours.OrderBy(t => t.Number).ToList();
        var tourIndex = orderedTours.IndexOf(_editingTour);
        return tourIndex < orderedTours.Count - 1 && orderedTours[tourIndex + 1].Questions.Count > 0;
    }

    private async Task NavigateToPrevQuestion()
    {
        if (_editingQuestion == null || _editingTour == null || _package == null) return;

        // Save current question first
        await SaveEditingQuestionAsync();

        var orderedQuestions = _editingTour.Questions.OrderBy(q => q.OrderIndex).ToList();
        var currentIndex = orderedQuestions.IndexOf(_editingQuestion);

        if (currentIndex > 0)
        {
            _editingQuestion = orderedQuestions[currentIndex - 1];
        }
        else
        {
            // Go to previous tour
            var orderedTours = _package.Tours.OrderBy(t => t.Number).ToList();
            var tourIndex = orderedTours.IndexOf(_editingTour);
            if (tourIndex > 0)
            {
                _editingTour = orderedTours[tourIndex - 1];
                _editingQuestion = _editingTour.Questions.OrderBy(q => q.OrderIndex).LastOrDefault();
            }
        }

        _questionSaveStatus = null;
        ResetMediaInputState();
        StateHasChanged();
    }

    private async Task NavigateToNextQuestion()
    {
        if (_editingQuestion == null || _editingTour == null || _package == null) return;

        // Save current question first
        await SaveEditingQuestionAsync();

        var orderedQuestions = _editingTour.Questions.OrderBy(q => q.OrderIndex).ToList();
        var currentIndex = orderedQuestions.IndexOf(_editingQuestion);

        if (currentIndex < orderedQuestions.Count - 1)
        {
            _editingQuestion = orderedQuestions[currentIndex + 1];
        }
        else
        {
            // Go to next tour
            var orderedTours = _package.Tours.OrderBy(t => t.Number).ToList();
            var tourIndex = orderedTours.IndexOf(_editingTour);
            if (tourIndex < orderedTours.Count - 1)
            {
                _editingTour = orderedTours[tourIndex + 1];
                _editingQuestion = _editingTour.Questions.OrderBy(q => q.OrderIndex).FirstOrDefault();
            }
        }

        _questionSaveStatus = null;
        ResetMediaInputState();
        StateHasChanged();
    }

    private async Task CreateAndNavigateToNextQuestion()
    {
        if (_editingTour == null || _package == null) return;

        // Save current question first
        await SaveEditingQuestionAsync();

        var question = await CreateQuestionAsync(_editingTour);
        if (question != null)
        {
            _editingQuestion = question;
            _questionSaveStatus = null;
            ResetMediaInputState();
        }
        StateHasChanged();
    }

    private bool IsExpanded(int tourId) => _expandedTours.Contains(tourId);

    private void ToggleExpand(int tourId)
    {
        if (_expandedTours.Contains(tourId))
            _expandedTours.Remove(tourId);
        else
            _expandedTours.Add(tourId);
    }


    private static string GetStatusBadgeClass(PackageStatus status) => status switch
    {
        PackageStatus.Draft => "bg-secondary",
        PackageStatus.Published => "bg-success",
        PackageStatus.Archived => "bg-warning text-dark",
        _ => "bg-secondary"
    };

    private static string GetStatusDisplayName(PackageStatus status) => status switch
    {
        PackageStatus.Draft => "Чернетка",
        PackageStatus.Published => "Опубліковано",
        PackageStatus.Archived => "Архів",
        _ => "Невідомо"
    };

    // ==================== Media Upload Methods ====================

    private static string GetFileName(string? url)
    {
        if (string.IsNullOrEmpty(url)) return "";
        var lastSlash = url.LastIndexOf('/');
        return lastSlash >= 0 ? url[(lastSlash + 1)..] : url;
    }

    /// <summary>
    /// Represents the target for media attachment operations.
    /// </summary>
    private enum MediaTarget
    {
        Handout,
        Comment
    }

    private async Task OnHandoutFileSelected(InputFileChangeEventArgs e)
    {
        await HandleFileUploadAsync(e.File, MediaTarget.Handout);
    }

    private async Task OnCommentFileSelected(InputFileChangeEventArgs e)
    {
        await HandleFileUploadAsync(e.File, MediaTarget.Comment);
    }

    private async Task DeleteHandoutMediaAsync()
    {
        await HandleMediaDeleteAsync(MediaTarget.Handout);
    }

    private async Task DeleteCommentMediaAsync()
    {
        await HandleMediaDeleteAsync(MediaTarget.Comment);
    }

    /// <summary>
    /// Unified handler for file upload operations (handout or comment).
    /// </summary>
    private async Task HandleFileUploadAsync(IBrowserFile file, MediaTarget target)
    {
        if (_editingQuestion == null) return;

        SetMediaOperationState(target, isLoading: true, error: null);
        StateHasChanged();

        try
        {
            // Validate file
            var (isValid, validationError) = MediaService.ValidateFile(file.Name, file.Size);
            if (!isValid)
            {
                SetMediaOperationState(target, isLoading: false, error: validationError);
                return;
            }

            // Remember existing URL for cleanup after successful upload
            var existingUrl = target == MediaTarget.Handout
                ? _editingQuestion.HandoutUrl
                : _editingQuestion.CommentAttachmentUrl;

            // Upload new file
            await using var stream = file.OpenReadStream(MaxUploadSize);
            var result = await MediaService.UploadAsync(stream, file.Name);

            if (!result.Success)
            {
                SetMediaOperationState(target, isLoading: false, error: result.ErrorMessage ?? "Помилка завантаження");
                return;
            }

            // Update question with new URL
            SetMediaUrl(target, result.RelativeUrl);

            // Save to database
            await using var context = await DbContextFactory.CreateDbContextAsync();
            var question = await context.Questions.FindAsync(_editingQuestion.Id);
            if (question != null)
            {
                if (target == MediaTarget.Handout)
                {
                    question.HandoutUrl = result.RelativeUrl;
                }
                else
                {
                    question.CommentAttachmentUrl = result.RelativeUrl;
                }
                await context.SaveChangesAsync();
            }

            // Delete old file after successful save
            if (!string.IsNullOrEmpty(existingUrl))
            {
                MediaService.Delete(existingUrl);
            }

            _questionSaveStatus = "Медіа завантажено";
        }
        catch (Exception ex)
        {
            SetMediaOperationState(target, isLoading: false, error: $"Помилка: {ex.Message}");
        }
        finally
        {
            SetMediaOperationState(target, isLoading: false, error: null, preserveError: true);
            StateHasChanged();
        }
    }

    /// <summary>
    /// Unified handler for media delete operations (handout or comment).
    /// </summary>
    private async Task HandleMediaDeleteAsync(MediaTarget target)
    {
        if (_editingQuestion == null) return;

        SetMediaOperationState(target, isLoading: true, error: null);
        StateHasChanged();

        try
        {
            // Get existing URL
            var existingUrl = target == MediaTarget.Handout
                ? _editingQuestion.HandoutUrl
                : _editingQuestion.CommentAttachmentUrl;

            if (string.IsNullOrEmpty(existingUrl))
            {
                SetMediaOperationState(target, isLoading: false, error: "Немає медіа для видалення");
                return;
            }

            // Update question in database first
            await using var context = await DbContextFactory.CreateDbContextAsync();
            var question = await context.Questions.FindAsync(_editingQuestion.Id);
            if (question != null)
            {
                if (target == MediaTarget.Handout)
                {
                    question.HandoutUrl = null;
                }
                else
                {
                    question.CommentAttachmentUrl = null;
                }
                await context.SaveChangesAsync();
            }

            // Delete file from disk
            MediaService.Delete(existingUrl);

            // Update local state
            SetMediaUrl(target, null);
            _questionSaveStatus = "Медіа видалено";
        }
        catch (Exception ex)
        {
            SetMediaOperationState(target, isLoading: false, error: $"Помилка: {ex.Message}");
        }
        finally
        {
            SetMediaOperationState(target, isLoading: false, error: null, preserveError: true);
            StateHasChanged();
        }
    }

    /// <summary>
    /// Sets the loading state and error message for a media operation.
    /// </summary>
    private void SetMediaOperationState(MediaTarget target, bool isLoading, string? error, bool preserveError = false)
    {
        if (target == MediaTarget.Handout)
        {
            _isUploadingHandout = isLoading;
            if (!preserveError) _handoutUploadError = error;
        }
        else
        {
            _isUploadingComment = isLoading;
            if (!preserveError) _commentUploadError = error;
        }
    }

    /// <summary>
    /// Sets the media URL on the editing question.
    /// </summary>
    private void SetMediaUrl(MediaTarget target, string? url)
    {
        if (_editingQuestion == null) return;

        if (target == MediaTarget.Handout)
        {
            _editingQuestion.HandoutUrl = url;
        }
        else
        {
            _editingQuestion.CommentAttachmentUrl = url;
        }
    }

    /// <summary>
    /// Resets the InputFile components by generating new keys, forcing re-render.
    /// Also clears any upload errors.
    /// </summary>
    private void ResetMediaInputState()
    {
        _handoutInputKey = Guid.NewGuid();
        _commentInputKey = Guid.NewGuid();
        _handoutUploadError = null;
        _commentUploadError = null;
    }

    /// <summary>
    /// Attempts to delete an author if they are orphaned (no questions, no tours, and not linked to a user).
    /// </summary>
    private async Task TryDeleteOrphanedAuthorAsync(Author author)
    {
        await AuthorService.TryDeleteAuthorIfOrphaned(author.Id);
    }
}

