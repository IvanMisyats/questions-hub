@page "/manage/package/{Id:int?}"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using Microsoft.JSInterop
@using QuestionsHub.Blazor.Domain
@using QuestionsHub.Blazor.Infrastructure
@attribute [Authorize(Roles = "Editor,Admin")]
@implements IAsyncDisposable

@inject IDbContextFactory<QuestionsHubDbContext> DbContextFactory
@inject NavigationManager Navigation
@inject MediaService MediaService
@inject AuthorService AuthorService
@inject PackageRenumberingService RenumberingService
@inject AccessControlService AccessControl
@inject IJSRuntime JS

<PageTitle>@(_package?.Title ?? "Новий пакет") - QuestionsHub</PageTitle>

<div class="container py-4">
    @if (_isLoading)
    {
        <div class="d-flex justify-content-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Завантаження...</span>
            </div>
        </div>
    }
    else if (_errorMessage != null)
    {
        <div class="alert alert-danger" role="alert">
            <i class="bi bi-exclamation-triangle me-2"></i>@_errorMessage
        </div>
        <a href="/manage/packages" class="btn btn-secondary">Повернутися до списку</a>
    }
    else if (_package != null)
    {
        <div class="d-flex justify-content-between align-items-center mb-4">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="/manage/packages">Мої пакети</a></li>
                    <li class="breadcrumb-item active" aria-current="page">@_package.Title</li>
                </ol>
            </nav>
            <div>
                @if (_saveStatus != null)
                {
                    <span class="text-muted me-3">
                        <i class="bi @(_isSaving ? "bi-arrow-repeat" : "bi-check-circle") me-1"></i>
                        @_saveStatus
                    </span>
                }
            </div>
        </div>

        <!-- Package Details Section -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Інформація про пакет</h5>
                <span class="badge @GetStatusBadgeClass(_package.Status)">@GetStatusDisplayName(_package.Status)</span>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-8">
                        <label for="packageTitle" class="form-label">Назва пакету</label>
                        <input type="text" class="form-control" id="packageTitle"
                               @bind="_package.Title" @onblur="SavePackageAsync" />
                    </div>
                    <div class="col-md-4">
                        <label for="packagePlayedAt" class="form-label">Дата проведення</label>
                        <input type="date" class="form-control" id="packagePlayedAt" lang="uk"
                               value="@(_package.PlayedAt?.ToString("yyyy-MM-dd"))"
                               @onchange="OnPlayedAtChanged" @onblur="SavePackageAsync" />
                    </div>
                    <div class="col-12">
                        <label for="packageDescription" class="form-label">Опис</label>
                        <textarea class="form-control auto-expand" id="packageDescription"
                                  @bind="_package.Description" @onblur="SavePackageAsync"></textarea>
                    </div>
                    <div class="col-12">
                        <label for="packagePreamble" class="form-label">Преамбула</label>
                        <textarea class="form-control auto-expand" id="packagePreamble"
                                  @bind="_package.Preamble" @onblur="SavePackageAsync"
                                  placeholder="Інформація від редактора, подяки тестерам тощо"></textarea>
                    </div>
                    <div class="col-md-4">
                        <label for="packageStatus" class="form-label">Статус</label>
                        <select class="form-select" id="packageStatus"
                                @bind="_package.Status" @onblur="SavePackageAsync">
                            <option value="@PackageStatus.Draft">Чернетка</option>
                            <option value="@PackageStatus.Published">Опубліковано</option>
                            <option value="@PackageStatus.Archived">Архів</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="packageNumberingMode" class="form-label">Нумерація питань</label>
                        <select class="form-select" id="packageNumberingMode"
                                value="@_package.NumberingMode"
                                @onchange="OnNumberingModeChanged">
                            <option value="@QuestionNumberingMode.Global">Наскрізна</option>
                            <option value="@QuestionNumberingMode.PerTour">Потурова</option>
                            <option value="@QuestionNumberingMode.Manual">Ручна</option>
                        </select>
                    </div>
                    @if (_package.Editors.Any())
                    {
                        <div class="col-12">
                            <label class="form-label">Редактори пакету</label>
                            <div class="text-muted small">
                                @string.Join(", ", _package.Editors.Select(e => e.FullName))
                                <span class="text-muted ms-2">(визначаються з турів)</span>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Tours Section -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Тури <span class="badge bg-secondary ms-2">@_package.Tours.Count(t => !t.IsWarmup)</span></h5>
                <button class="btn btn-success btn-sm" @onclick="AddTourAsync">
                    <i class="bi bi-plus-lg me-1"></i>Додати тур
                </button>
            </div>
            <div class="card-body">
                @if (_package.Tours.Count == 0)
                {
                    <div class="text-center py-4 text-muted">
                        <i class="bi bi-collection fs-1 d-block mb-2"></i>
                        <p>Пакет ще не має турів. Натисніть "Додати тур", щоб почати.</p>
                    </div>
                }
                else
                {
                    <div class="accordion" id="toursAccordion">
                        @foreach (var tour in _package.Tours.OrderBy(t => t.OrderIndex))
                        {
                            <div class="accordion-item" data-tour-id="@tour.Id">
                                <h2 class="accordion-header d-flex align-items-center">
                                    <span class="tour-drag-handle" title="Перетягніть для зміни порядку">
                                        <Icon Name="drag" />
                                    </span>
                                    <button class="accordion-button flex-grow-1 @(IsExpanded(tour.Id) ? "" : "collapsed")" type="button"
                                            @onclick="() => ToggleExpand(tour.Id)">
                                        <span class="me-2">
                                            @if (tour.IsWarmup)
                                            {
                                                <span class="badge bg-warning text-dark me-1">Розминка</span>
                                            }
                                            else
                                            {
                                                <strong>Тур @tour.Number</strong>
                                            }
                                        </span>
                                        <span class="badge bg-info ms-auto me-2">@tour.Questions.Count питань</span>
                                    </button>
                                </h2>
                                <div class="accordion-collapse collapse @(IsExpanded(tour.Id) ? "show" : "")"
                                     id="tour-@tour.Id">
                                    <div class="accordion-body">
                                        <!-- Tour Edit Controls -->
                                        <div class="row g-2 mb-3 pb-3 border-bottom">
                                            <div class="col-md-2 d-flex align-items-center">
                                                <div class="form-check">
                                                    <input type="checkbox" class="form-check-input" id="warmup-@tour.Id"
                                                           checked="@tour.IsWarmup"
                                                           @onchange="e => OnWarmupChanged(tour, (bool)(e.Value ?? false))"
                                                           disabled="@(_package.Tours.Any(t => t.IsWarmup && t.Id != tour.Id) && !tour.IsWarmup ? false : false)" />
                                                    <label class="form-check-label small" for="warmup-@tour.Id">Розминка</label>
                                                </div>
                                            </div>
                                            @if (!tour.HasBlocks)
                                            {
                                                <div class="col-md-8">
                                                    <label class="form-label small">Редактори туру</label>
                                                    <AuthorSelector SelectedAuthors="tour.Editors"
                                                                    OnSelectionChanged="() => SaveTourAsync(tour)"
                                                                    OnAuthorRemoved="TryDeleteOrphanedAuthorAsync"
                                                                    Placeholder="Введіть прізвище редактора..." />
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="col-md-8">
                                                    <label class="form-label small">Редактори туру</label>
                                                    <div class="text-muted small">
                                                        @string.Join(", ", tour.AllEditors.Select(e => e.FullName))
                                                        <span class="text-muted ms-2">(визначаються з блоків)</span>
                                                    </div>
                                                </div>
                                            }
                                            <div class="col-md-2 d-flex align-items-end">
                                                <button class="btn btn-outline-danger btn-sm w-100"
                                                        @onclick="() => ConfirmDeleteTour(tour)">
                                                    <i class="bi bi-trash"></i> Видалити
                                                </button>
                                            </div>
                                            <div class="col-12">
                                                <label class="form-label small">Преамбула</label>
                                                <textarea class="form-control form-control-sm auto-expand"
                                                          @bind="tour.Preamble" @onblur="() => SaveTourAsync(tour)"
                                                          placeholder="Інформація від редактора, подяки тестерам тощо"></textarea>
                                            </div>
                                        </div>

                                        @if (tour.HasBlocks)
                                        {
                                            <!-- Blocks Section -->
                                            <div class="blocks-section mb-3" id="blocks-tour-@tour.Id" data-tour-id="@tour.Id">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <h6 class="mb-0">Блоки <span class="badge bg-secondary">@tour.Blocks.Count</span></h6>
                                                    @if (tour.Blocks.Count < 6)
                                                    {
                                                        <button class="btn btn-outline-primary btn-sm" @onclick="() => AddBlockAsync(tour)">
                                                            + Додати блок
                                                        </button>
                                                    }
                                                </div>

                                                @foreach (var block in tour.Blocks.OrderBy(b => b.OrderIndex))
                                                {
                                                    var blockNumber = tour.Blocks.OrderBy(b => b.OrderIndex).ToList().IndexOf(block) + 1;
                                                    var isBlockExpanded = IsBlockExpanded(block.Id);
                                                    <div class="card mb-3 block-item" data-block-id="@block.Id">
                                                        <div class="card-header d-flex justify-content-between align-items-center py-2">
                                                            <div class="d-flex align-items-center gap-2">
                                                                <span class="block-drag-handle" title="Перетягніть для зміни порядку">
                                                                    <Icon Name="drag" />
                                                                </span>
                                                                <span style="font-size: 0.8rem; cursor: pointer;" @onclick="() => ToggleBlockExpand(block.Id)">@(isBlockExpanded ? "▼" : "▶")</span>
                                                                <strong style="cursor: pointer;" @onclick="() => ToggleBlockExpand(block.Id)">Блок @blockNumber</strong>
                                                                @if (!string.IsNullOrWhiteSpace(block.Name))
                                                                {
                                                                    <span class="text-muted" style="cursor: pointer;" @onclick="() => ToggleBlockExpand(block.Id)">— @block.Name</span>
                                                                }
                                                                <span class="badge bg-secondary">@tour.Questions.Count(q => q.BlockId == block.Id) питань</span>
                                                            </div>
                                                            <button class="btn btn-outline-danger btn-sm d-flex align-items-center justify-content-center"
                                                                    style="width: 24px; height: 24px; padding: 0; font-size: 1rem; line-height: 1;"
                                                                    @onclick="() => ConfirmDeleteBlock(tour, block)"
                                                                    @onclick:stopPropagation="true"
                                                                    title="Видалити блок (питання залишаться у турі)">×</button>
                                                        </div>
                                                        @if (isBlockExpanded)
                                                        {
                                                        <div class="card-body py-2">
                                                            <div class="row g-2 mb-2">
                                                                <div class="col-md-4">
                                                                    <label class="form-label small">Назва блоку (необов'язково)</label>
                                                                    <input type="text" class="form-control form-control-sm"
                                                                           @bind="block.Name" @onblur="() => SaveBlockAsync(block)"
                                                                           placeholder="@block.DisplayName" />
                                                                </div>
                                                                <div class="col-md-8">
                                                                    <label class="form-label small">Редактори блоку</label>
                                                                    <AuthorSelector SelectedAuthors="block.Editors"
                                                                                    OnSelectionChanged="() => SaveBlockAsync(block)"
                                                                                    OnAuthorRemoved="TryDeleteOrphanedAuthorAsync"
                                                                                    Placeholder="Введіть прізвище редактора..." />
                                                                </div>
                                                                <div class="col-12">
                                                                    <label class="form-label small">Преамбула блоку</label>
                                                                    <textarea class="form-control form-control-sm auto-expand"
                                                                              @bind="block.Preamble" @onblur="() => SaveBlockAsync(block)"
                                                                              placeholder="Інформація від редактора блоку"></textarea>
                                                                </div>
                                                            </div>

                                                            <!-- Questions in this block -->
                                                            @{
                                                                var blockQuestions = tour.Questions.Where(q => q.BlockId == block.Id).OrderBy(q => q.OrderIndex).ToList();
                                                            }
                                                            <div class="list-group mb-2" id="questions-block-@block.Id" data-block-id="@block.Id" data-tour-id="@tour.Id">
                                                            @if (blockQuestions.Any())
                                                            {
                                                                @foreach (var question in blockQuestions)
                                                                {
                                                                    <div @key="question.Id" class="list-group-item list-group-item-action d-flex align-items-center gap-2 py-1"
                                                                         data-question-id="@question.Id">
                                                                        <span class="question-drag-handle flex-shrink-0" title="Перетягніть для зміни порядку">
                                                                            <Icon Name="drag" Size="14" />
                                                                        </span>
                                                                        <span class="badge bg-primary flex-shrink-0">@question.Number</span>
                                                                        <div class="flex-grow-1 small" style="cursor: pointer;"
                                                                             @onclick="() => OpenQuestionEditor(tour, question)">
                                                                            @question.Text
                                                                        </div>
                                                                        <button class="btn btn-danger flex-shrink-0 d-flex align-items-center justify-content-center"
                                                                                style="width: 20px; height: 20px; padding: 0; font-size: 1rem; line-height: 1;"
                                                                                @onclick="() => ConfirmDeleteQuestion(tour, question)"
                                                                                @onclick:stopPropagation="true"
                                                                                title="Видалити">×</button>
                                                                    </div>
                                                                }
                                                            }
                                                            else
                                                            {
                                                                <div class="list-group-item text-center text-muted py-2">
                                                                    <small>Перетягніть сюди питання</small>
                                                                </div>
                                                            }
                                                            </div>
                                                            <button class="btn btn-outline-success btn-sm"
                                                                    @onclick="() => AddQuestionToBlockAsync(tour, block)">
                                                                + Додати питання
                                                            </button>
                                                        </div>
                                                        }
                                                    </div>
                                                }
                                            </div>

                                            @* Orphan questions section - questions not assigned to any block *@
                                            var orphanQuestions = tour.Questions.Where(q => q.BlockId == null).OrderBy(q => q.OrderIndex).ToList();
                                            if (orphanQuestions.Any())
                                            {
                                                <div class="card mb-3 border-warning">
                                                    <div class="card-header d-flex justify-content-between align-items-center py-2 bg-warning-subtle">
                                                        <div class="d-flex align-items-center gap-2">
                                                            <i class="bi bi-exclamation-triangle text-warning"></i>
                                                            <strong>Питання поза блоками</strong>
                                                            <span class="badge bg-warning text-dark">@orphanQuestions.Count питань</span>
                                                        </div>
                                                    </div>
                                                    <div class="card-body py-2">
                                                        <p class="text-muted small mb-2">Ці питання не належать жодному блоку. Перетягніть їх до відповідного блоку.</p>
                                                        <div class="list-group mb-2" id="questions-orphan-@tour.Id" data-tour-id="@tour.Id" data-block-id="">
                                                            @foreach (var question in orphanQuestions)
                                                            {
                                                                <div @key="question.Id" class="list-group-item list-group-item-action d-flex align-items-center gap-2 py-1"
                                                                     data-question-id="@question.Id">
                                                                    <span class="question-drag-handle flex-shrink-0" title="Перетягніть для зміни порядку">
                                                                        <Icon Name="drag" Size="14" />
                                                                    </span>
                                                                    <span class="badge bg-primary flex-shrink-0">@question.Number</span>
                                                                    <div class="flex-grow-1 small" style="cursor: pointer;"
                                                                         @onclick="() => OpenQuestionEditor(tour, question)">
                                                                        @question.Text
                                                                    </div>
                                                                    <button class="btn btn-danger flex-shrink-0 d-flex align-items-center justify-content-center"
                                                                            style="width: 20px; height: 20px; padding: 0; font-size: 1rem; line-height: 1;"
                                                                            @onclick="() => ConfirmDeleteQuestion(tour, question)"
                                                                            @onclick:stopPropagation="true"
                                                                            title="Видалити">×</button>
                                                                </div>
                                                            }
                                                        </div>
                                                    </div>
                                                </div>
                                            }
                                        }
                                        else
                                        {
                                            <!-- No blocks - show questions directly and "Add Block" button -->
                                            <div class="mb-3">
                                                <button class="btn btn-outline-secondary btn-sm" @onclick="() => AddBlockAsync(tour)">
                                                    ☰ Розділити на блоки
                                                </button>
                                            </div>

                                            <!-- Questions List -->
                                            <div class="list-group mb-3" id="questions-tour-@tour.Id" data-tour-id="@tour.Id">
                                            @if (tour.Questions.Count == 0)
                                            {
                                                <div class="list-group-item text-center text-muted py-3">
                                                    <p class="mb-0">Тур ще не має питань. Перетягніть сюди питання або додайте нове.</p>
                                                </div>
                                            }
                                            else
                                            {
                                                @foreach (var question in tour.Questions.OrderBy(q => q.OrderIndex))
                                                {
                                                    <div @key="question.Id" class="list-group-item list-group-item-action d-flex align-items-center gap-2"
                                                         data-question-id="@question.Id">
                                                        <span class="question-drag-handle flex-shrink-0" title="Перетягніть для зміни порядку">
                                                            <Icon Name="drag" />
                                                        </span>
                                                        <span class="badge bg-primary flex-shrink-0">@question.Number</span>
                                                        <div class="flex-grow-1" style="cursor: pointer;"
                                                             @onclick="() => OpenQuestionEditor(tour, question)">
                                                            @question.Text
                                                        </div>
                                                        <button class="btn btn-danger flex-shrink-0 d-flex align-items-center justify-content-center"
                                                                style="width: 24px; height: 24px; padding: 0; font-size: 1.25rem; line-height: 1;"
                                                                @onclick="() => ConfirmDeleteQuestion(tour, question)"
                                                                @onclick:stopPropagation="true"
                                                                title="Видалити">×</button>
                                                    </div>
                                                }
                                            }
                                            </div>

                                            <button class="btn btn-outline-success btn-sm"
                                                    @onclick="() => AddQuestionAsync(tour)">
                                                <i class="bi bi-plus-lg me-1"></i>Додати питання
                                            </button>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    <div class="mt-3 text-center">
                        <button class="btn btn-success" @onclick="AddTourAsync">
                            <i class="bi bi-plus-lg me-1"></i>Додати тур
                        </button>
                    </div>
                }
            </div>
        </div>
    }
</div>

<!-- Delete Tour Modal -->
@if (_showDeleteTourModal && _tourToDelete != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Видалити тур</h5>
                    <button type="button" class="btn-close" @onclick="CancelDeleteTour"></button>
                </div>
                <div class="modal-body">
                    <p>Ви впевнені, що хочете видалити <strong>Тур @_tourToDelete.Number</strong>?</p>
                    <p class="text-danger mb-0">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Всі @_tourToDelete.Questions.Count питань туру будуть видалені.
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CancelDeleteTour">Скасувати</button>
                    <button type="button" class="btn btn-danger" @onclick="DeleteTourAsync">Видалити</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Delete Question Modal -->
@if (_showDeleteQuestionModal && _questionToDelete != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Видалити питання</h5>
                    <button type="button" class="btn-close" @onclick="CancelDeleteQuestion"></button>
                </div>
                <div class="modal-body">
                    <p>Ви впевнені, що хочете видалити <strong>Питання @_questionToDelete.Number</strong>?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CancelDeleteQuestion">Скасувати</button>
                    <button type="button" class="btn btn-danger" @onclick="DeleteQuestionAsync">Видалити</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Delete Block Modal -->
@if (_showDeleteBlockModal && _blockToDelete != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Видалити блок</h5>
                    <button type="button" class="btn-close" @onclick="CancelDeleteBlock"></button>
                </div>
                <div class="modal-body">
                    <p>Ви впевнені, що хочете видалити <strong>@_blockToDelete.DisplayName</strong>?</p>
                    <p class="text-info mb-0">
                        <i class="bi bi-info-circle me-2"></i>
                        @{
                            var blockQuestionCount = _blockToDeleteTour?.Questions.Count(q => q.BlockId == _blockToDelete.Id) ?? 0;
                        }
                        @if (blockQuestionCount > 0)
                        {
                            <text>@blockQuestionCount питань блоку залишаться у турі.</text>
                        }
                        else
                        {
                            <text>Блок не містить питань.</text>
                        }
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CancelDeleteBlock">Скасувати</button>
                    <button type="button" class="btn btn-danger" @onclick="DeleteBlockAsync">Видалити</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Question Editor Modal -->
@if (_showQuestionEditor && _editingQuestion != null && _editingTour != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-xl modal-dialog-scrollable modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        Питання @_editingQuestion.Number
                        <span class="text-muted">(Тур @_editingTour.Number)</span>
                    </h5>
                    <div class="ms-auto me-3">
                        <button class="btn btn-outline-secondary btn-sm me-1"
                                @onclick="NavigateToPrevQuestion"
                                disabled="@(!CanNavigatePrev())">
                            <i class="bi bi-chevron-left"></i> Попереднє
                        </button>
                        <button class="btn btn-outline-secondary btn-sm"
                                @onclick="NavigateToNextQuestion"
                                disabled="@(!CanNavigateNext())">
                            Наступне <i class="bi bi-chevron-right"></i>
                        </button>
                        @if (!CanNavigateNext())
                        {
                            <button class="btn btn-outline-success btn-sm ms-1"
                                    @onclick="CreateAndNavigateToNextQuestion"
                                    title="Створити нове питання в цьому турі">
                                <i class="bi bi-plus-lg"></i> Створити наступне
                            </button>
                        }
                    </div>
                    <button type="button" class="btn-close" @onclick="CloseQuestionEditor"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-2">
                        <div class="col-md-2">
                            <label class="col-form-label">Номер</label>
                        </div>
                        <div class="col-md-10">
                            <input type="text" class="form-control" style="max-width: 100px;"
                                   @bind="_editingQuestion.Number" @onblur="SaveEditingQuestionAsync"
                                   disabled="@(_package?.NumberingMode != QuestionNumberingMode.Manual)" />
                            @if (_package?.NumberingMode != QuestionNumberingMode.Manual)
                            {
                                <small class="text-muted">Автоматична нумерація</small>
                            }
                        </div>
                        <div class="col-md-2">
                            <label class="col-form-label">Вказівка ведучому</label>
                        </div>
                        <div class="col-md-10">
                            <textarea class="form-control auto-expand" placeholder="Інструкції для ведучого/організатора"
                                      @bind="_editingQuestion.HostInstructions" @onblur="SaveEditingQuestionAsync"></textarea>
                        </div>
                        <div class="col-md-2">
                            <label class="col-form-label">Роздатковий матеріал</label>
                        </div>
                        <div class="col-md-10">
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <textarea class="form-control auto-expand" placeholder="Текст роздавального матеріалу"
                                              @bind="_editingQuestion.HandoutText" @onblur="SaveEditingQuestionAsync"></textarea>
                                </div>
                                <div class="col-md-6">
                                    @if (!string.IsNullOrEmpty(_editingQuestion.HandoutUrl))
                                    {
                                        <div class="mb-2 p-2 border rounded bg-light">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <a href="@_editingQuestion.HandoutUrl" target="_blank" class="text-truncate small">
                                                    <i class="bi bi-box-arrow-up-right me-1"></i>@GetFileName(_editingQuestion.HandoutUrl)
                                                </a>
                                                <button type="button" class="btn btn-danger btn-sm"
                                                        @onclick="DeleteHandoutMediaAsync"
                                                        disabled="@_isUploadingHandout">
                                                    <i class="bi bi-trash me-1"></i>Видалити
                                                </button>
                                            </div>
                                            @{
                                                var handoutMediaType = MediaSecurityOptions.GetMediaType(_editingQuestion.HandoutUrl);
                                            }
                                            @switch (handoutMediaType)
                                            {
                                                case MediaType.Image:
                                                    <img src="@_editingQuestion.HandoutUrl" alt="Роздатковий матеріал"
                                                         class="img-fluid rounded" style="max-height: 200px;" />
                                                    break;
                                                case MediaType.Video:
                                                    <video controls class="rounded" style="max-width: 100%; max-height: 200px;">
                                                        <source src="@_editingQuestion.HandoutUrl"
                                                                type="@MediaSecurityOptions.GetContentTypeFromPath(_editingQuestion.HandoutUrl)" />
                                                        Ваш браузер не підтримує відтворення відео.
                                                    </video>
                                                    break;
                                                case MediaType.Audio:
                                                    <audio controls style="width: 100%; max-width: 400px;">
                                                        <source src="@_editingQuestion.HandoutUrl"
                                                                type="@MediaSecurityOptions.GetContentTypeFromPath(_editingQuestion.HandoutUrl)" />
                                                        Ваш браузер не підтримує відтворення аудіо.
                                                    </audio>
                                                    break;
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="input-group" @key="_handoutInputKey">
                                            <InputFile class="form-control"
                                                       OnChange="OnHandoutFileSelected"
                                                       accept=".jpg,.jpeg,.png,.gif,.webp,.mp4,.webm,.mp3,.ogg,.wav"
                                                       disabled="@_isUploadingHandout" />
                                            @if (_isUploadingHandout)
                                            {
                                                <span class="input-group-text">
                                                    <span class="spinner-border spinner-border-sm" role="status"></span>
                                                </span>
                                            }
                                        </div>
                                    }
                                    @if (!string.IsNullOrEmpty(_handoutUploadError))
                                    {
                                        <div class="text-danger small mt-1">
                                            <i class="bi bi-exclamation-circle me-1"></i>@_handoutUploadError
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label class="col-form-label">Текст питання <span class="text-danger">*</span></label>
                        </div>
                        <div class="col-md-10">
                            <textarea class="form-control auto-expand @(_isTextEmpty ? "field-required-empty" : "")"
                                      @bind="_editingQuestion.Text" @onblur="OnTextBlurAsync"></textarea>
                        </div>
                        <div class="col-md-2">
                            <label class="col-form-label">Відповідь <span class="text-danger">*</span></label>
                        </div>
                        <div class="col-md-10">
                            <input type="text" class="form-control @(_isAnswerEmpty ? "field-required-empty" : "")"
                                   @bind="_editingQuestion.Answer" @onblur="OnAnswerBlurAsync" />
                        </div>
                        <div class="col-md-2">
                            <label class="col-form-label">Залік</label>
                        </div>
                        <div class="col-md-5">
                            <input type="text" class="form-control" placeholder="альтернативні відповіді"
                                   @bind="_editingQuestion.AcceptedAnswers" @onblur="SaveEditingQuestionAsync" />
                        </div>
                        <div class="col-md-2 text-end">
                            <label class="col-form-label">Незалік</label>
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control"
                                   @bind="_editingQuestion.RejectedAnswers" @onblur="SaveEditingQuestionAsync" />
                        </div>
                        <div class="col-md-2">
                            <label class="col-form-label">Коментар</label>
                        </div>
                        <div class="col-md-10">
                            <textarea class="form-control auto-expand"
                                      @bind="_editingQuestion.Comment" @onblur="SaveEditingQuestionAsync"></textarea>
                        </div>
                        <div class="col-md-2">
                            <label class="col-form-label">Ілюстрація</label>
                        </div>
                        <div class="col-md-10">
                            @if (!string.IsNullOrEmpty(_editingQuestion.CommentAttachmentUrl))
                            {
                                <div class="mb-2 p-2 border rounded bg-light">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <a href="@_editingQuestion.CommentAttachmentUrl" target="_blank" class="text-truncate small">
                                            <i class="bi bi-box-arrow-up-right me-1"></i>@GetFileName(_editingQuestion.CommentAttachmentUrl)
                                        </a>
                                        <button type="button" class="btn btn-danger btn-sm"
                                                @onclick="DeleteCommentMediaAsync"
                                                disabled="@_isUploadingComment">
                                            <i class="bi bi-trash me-1"></i>Видалити
                                        </button>
                                    </div>
                                    @{
                                        var commentMediaType = MediaSecurityOptions.GetMediaType(_editingQuestion.CommentAttachmentUrl);
                                    }
                                    @switch (commentMediaType)
                                    {
                                        case MediaType.Image:
                                            <img src="@_editingQuestion.CommentAttachmentUrl" alt="Ілюстрація до коментаря"
                                                 class="img-fluid rounded" style="max-height: 200px;" />
                                            break;
                                        case MediaType.Video:
                                            <video controls class="rounded" style="max-width: 100%; max-height: 200px;">
                                                <source src="@_editingQuestion.CommentAttachmentUrl"
                                                        type="@MediaSecurityOptions.GetContentTypeFromPath(_editingQuestion.CommentAttachmentUrl)" />
                                                Ваш браузер не підтримує відтворення відео.
                                            </video>
                                            break;
                                        case MediaType.Audio:
                                            <audio controls style="width: 100%; max-width: 400px;">
                                                <source src="@_editingQuestion.CommentAttachmentUrl"
                                                        type="@MediaSecurityOptions.GetContentTypeFromPath(_editingQuestion.CommentAttachmentUrl)" />
                                                Ваш браузер не підтримує відтворення аудіо.
                                            </audio>
                                            break;
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="input-group" @key="_commentInputKey">
                                    <InputFile class="form-control"
                                               OnChange="OnCommentFileSelected"
                                               accept=".jpg,.jpeg,.png,.gif,.webp,.mp4,.webm,.mp3,.ogg,.wav"
                                               disabled="@_isUploadingComment" />
                                    @if (_isUploadingComment)
                                    {
                                        <span class="input-group-text">
                                            <span class="spinner-border spinner-border-sm" role="status"></span>
                                        </span>
                                    }
                                </div>
                            }
                            @if (!string.IsNullOrEmpty(_commentUploadError))
                            {
                                <div class="text-danger small mt-1">
                                    <i class="bi bi-exclamation-circle me-1"></i>@_commentUploadError
                                </div>
                            }
                        </div>
                        <div class="col-md-2">
                            <label class="col-form-label @(_isSourceEmpty ? "text-danger" : "")">Джерело <span class="text-danger">*</span></label>
                        </div>
                        <div class="col-md-10">
                            <textarea class="form-control auto-expand @(_isSourceEmpty ? "field-required-empty" : "")" placeholder="Джерела інформації (кожне з нового рядка)"
                                      @bind="_editingQuestion.Source" @onblur="OnSourceBlurAsync"></textarea>
                        </div>
                        <div class="col-md-2">
                            <label class="col-form-label @(_areAuthorsEmpty ? "text-danger" : "")">Автори <span class="text-danger">*</span></label>
                        </div>
                        <div class="col-md-10">
                            <div class="@(_areAuthorsEmpty ? "author-selector-required-empty" : "")">
                                <AuthorSelector SelectedAuthors="_editingQuestion.Authors"
                                                OnSelectionChanged="OnAuthorsChangedAsync"
                                                OnAuthorRemoved="TryDeleteOrphanedAuthorAsync"
                                                Placeholder="Введіть прізвище автора..." />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    @if (_questionSaveStatus != null)
                    {
                        <span class="text-muted me-auto">
                            <i class="bi bi-check-circle me-1"></i>@_questionSaveStatus
                        </span>
                    }
                    <button type="button" class="btn btn-secondary" @onclick="CloseQuestionEditor">Закрити</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public int? Id { get; set; }

    private Package? _package;
    private bool _isLoading = true;
    private string? _errorMessage;
    private string? _userId;
    private bool _isSaving;
    private string? _saveStatus;

    // Accordion state
    private HashSet<int> _expandedTours = new();
    private HashSet<int> _expandedBlocks = new();

    // Delete tour modal
    private bool _showDeleteTourModal;
    private Tour? _tourToDelete;

    // Delete question modal
    private bool _showDeleteQuestionModal;
    private Question? _questionToDelete;
    private Tour? _questionToDeleteTour;

    // Delete block modal
    private bool _showDeleteBlockModal;
    private Block? _blockToDelete;
    private Tour? _blockToDeleteTour;

    // Question editor modal
    private bool _showQuestionEditor;
    private Question? _editingQuestion;
    private Tour? _editingTour;
    private string? _questionSaveStatus;

    // Media upload state
    private bool _isUploadingHandout;
    private bool _isUploadingComment;
    private string? _handoutUploadError;
    private string? _commentUploadError;
    private const long MaxUploadSize = 100 * 1024 * 1024; // 100 MB max for streaming
    private Guid _handoutInputKey = Guid.NewGuid();
    private Guid _commentInputKey = Guid.NewGuid();

    // Validation state for mandatory fields
    private bool _isTextEmpty;
    private bool _isAnswerEmpty;
    private bool _isSourceEmpty;
    private bool _areAuthorsEmpty;

    // JS Interop for sortable
    private DotNetObjectReference<ManagePackageDetail>? _dotNetRef;

    protected override async Task OnInitializedAsync()
    {
        _dotNetRef = DotNetObjectReference.Create(this);
        await CheckUserAsync();
        await LoadPackageAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_needsSortableInit && !_isLoading && _package != null)
        {
            _needsSortableInit = false;
            // Small delay to ensure DOM is fully rendered
            await Task.Delay(50);
            await InitializeSortables();
        }
    }

    private bool _needsSortableInit = true;

    private async Task InitializeSortables()
    {
        if (_package == null || _dotNetRef == null) return;

        try
        {
            // Initialize tours sortable
            await JS.InvokeVoidAsync("sortableInterop.initToursSortable", "toursAccordion", _dotNetRef);

            // Initialize sortables for each tour
            foreach (var tour in _package.Tours)
            {
                if (tour.HasBlocks)
                {
                    // Initialize blocks sortable for this tour
                    await JS.InvokeVoidAsync("sortableInterop.initBlocksSortable",
                        $"blocks-tour-{tour.Id}", tour.Id, _dotNetRef);

                    // Initialize questions sortable for each block
                    foreach (var block in tour.Blocks)
                    {
                        await JS.InvokeVoidAsync("sortableInterop.initBlockQuestionsSortable",
                            $"questions-block-{block.Id}", tour.Id, block.Id, _dotNetRef);
                    }

                    // Initialize orphan questions sortable (questions without block)
                    var hasOrphanQuestions = tour.Questions.Any(q => q.BlockId == null);
                    if (hasOrphanQuestions)
                    {
                        await JS.InvokeVoidAsync("sortableInterop.initBlockQuestionsSortable",
                            $"questions-orphan-{tour.Id}", tour.Id, null, _dotNetRef);
                    }
                }
                else
                {
                    // Initialize questions sortable for tour (no blocks)
                    await JS.InvokeVoidAsync("sortableInterop.initQuestionsSortable",
                        $"questions-tour-{tour.Id}", tour.Id, _dotNetRef);
                }
            }
        }
        catch (JSDisconnectedException)
        {
            // Ignore - component is being disposed
        }
        catch (JSException ex)
        {
            Console.WriteLine($"Error initializing sortables: {ex.Message}");
        }
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("sortableInterop.destroyAll");
        }
        catch (JSDisconnectedException)
        {
            // Ignore - already disconnected
        }

        _dotNetRef?.Dispose();
    }

    [JSInvokable]
    public async Task OnToursReordered(int[] tourIds)
    {
        if (_package == null) return;

        try
        {
            _saveStatus = "Зміна порядку турів...";
            StateHasChanged();

            await using var context = await DbContextFactory.CreateDbContextAsync();

            // Update tour OrderIndex based on new order
            for (int i = 0; i < tourIds.Length; i++)
            {
                var tour = _package.Tours.FirstOrDefault(t => t.Id == tourIds[i]);
                if (tour != null)
                {
                    tour.OrderIndex = i;

                    var dbTour = await context.Tours.FindAsync(tour.Id);
                    if (dbTour != null)
                    {
                        dbTour.OrderIndex = i;
                    }
                }
            }

            await context.SaveChangesAsync();

            // Renumber using the service
            await RenumberingService.RenumberPackage(_package.Id);

            // Reload to get updated numbers
            await ReloadPackageData();

            _saveStatus = "Порядок турів змінено";
        }
        catch (Exception ex)
        {
            _saveStatus = $"Помилка: {ex.Message}";
        }

        StateHasChanged();
    }

    [JSInvokable]
    public async Task OnBlocksReordered(int tourId, int[] blockIds)
    {
        if (_package == null) return;

        try
        {
            _saveStatus = "Зміна порядку блоків...";
            StateHasChanged();

            var tour = _package.Tours.FirstOrDefault(t => t.Id == tourId);
            if (tour == null) return;

            await using var context = await DbContextFactory.CreateDbContextAsync();

            // Update block order indices based on new order
            for (int i = 0; i < blockIds.Length; i++)
            {
                var block = tour.Blocks.FirstOrDefault(b => b.Id == blockIds[i]);
                if (block != null)
                {
                    block.OrderIndex = i;

                    var dbBlock = await context.Blocks.FindAsync(block.Id);
                    if (dbBlock != null)
                    {
                        dbBlock.OrderIndex = i;
                    }
                }
            }

            await context.SaveChangesAsync();

            _saveStatus = "Порядок блоків змінено";
        }
        catch (Exception ex)
        {
            _saveStatus = $"Помилка: {ex.Message}";
        }

        StateHasChanged();
    }

    /// <summary>
    /// DTO for receiving question order from JavaScript.
    /// </summary>
    public class QuestionOrderItem
    {
        public int QuestionId { get; set; }
        public int? BlockId { get; set; }
    }

    [JSInvokable]
    public async Task OnTourQuestionsReordered(int toTourId, List<QuestionOrderItem> toTourOrder, int? fromTourId, List<QuestionOrderItem>? fromTourOrder)
    {
        if (_package == null) return;

        try
        {
            _saveStatus = "Оновлення порядку питань...";
            StateHasChanged();

            await using var context = await DbContextFactory.CreateDbContextAsync();

            // Process target tour
            await UpdateTourQuestionOrder(context, toTourId, toTourOrder);

            // Process source tour if different
            if (fromTourId.HasValue && fromTourId.Value != toTourId && fromTourOrder != null)
            {
                await UpdateTourQuestionOrder(context, fromTourId.Value, fromTourOrder);
            }

            await context.SaveChangesAsync();

            // Renumber using the service
            await RenumberingService.RenumberPackage(_package.Id);

            // Reload to get updated numbers
            await ReloadPackageData();

            _saveStatus = "Порядок питань оновлено";
        }
        catch (Exception ex)
        {
            _saveStatus = $"Помилка: {ex.Message}";
        }

        StateHasChanged();
    }

    private async Task UpdateTourQuestionOrder(QuestionsHubDbContext context, int tourId, List<QuestionOrderItem> order)
    {
        var tour = _package!.Tours.FirstOrDefault(t => t.Id == tourId);
        if (tour == null) return;

        for (int i = 0; i < order.Count; i++)
        {
            var item = order[i];
            var question = tour.Questions.FirstOrDefault(q => q.Id == item.QuestionId);

            // If question is from a different tour, we need to move it
            if (question == null)
            {
                // Find the question in other tours
                foreach (var otherTour in _package.Tours.Where(t => t.Id != tourId))
                {
                    question = otherTour.Questions.FirstOrDefault(q => q.Id == item.QuestionId);
                    if (question != null)
                    {
                        // Move question to this tour
                        otherTour.Questions.Remove(question);
                        question.TourId = tourId;
                        tour.Questions.Add(question);
                        break;
                    }
                }
            }

            if (question != null)
            {
                question.OrderIndex = i;
                question.BlockId = item.BlockId;

                var dbQuestion = await context.Questions.FindAsync(question.Id);
                if (dbQuestion != null)
                {
                    dbQuestion.OrderIndex = i;
                    dbQuestion.BlockId = item.BlockId;
                    dbQuestion.TourId = tourId;
                }
            }
        }
    }

    [JSInvokable]
    public async Task OnQuestionMoved(int questionId, int fromTourId, int toTourId, int newIndex, int? fromBlockId = null, int? toBlockId = null)
    {
        if (_package == null) return;

        try
        {
            _saveStatus = "Переміщення питання...";
            StateHasChanged();

            var sourceTour = _package.Tours.FirstOrDefault(t => t.Id == fromTourId);
            var targetTour = _package.Tours.FirstOrDefault(t => t.Id == toTourId);
            var question = sourceTour?.Questions.FirstOrDefault(q => q.Id == questionId);

            if (sourceTour == null || targetTour == null || question == null)
            {
                _saveStatus = "Помилка: питання або тур не знайдено";
                StateHasChanged();
                return;
            }

            await using var context = await DbContextFactory.CreateDbContextAsync();

            var isSameTour = fromTourId == toTourId;
            var isSameBlock = fromBlockId == toBlockId;

            if (isSameTour && isSameBlock)
            {
                // Reordering within the same tour/block
                var questions = (toBlockId.HasValue
                    ? sourceTour.Questions.Where(q => q.BlockId == toBlockId)
                    : sourceTour.Questions.Where(q => q.BlockId == null))
                    .OrderBy(q => q.OrderIndex).ToList();

                var oldIndex = questions.IndexOf(question);

                if (oldIndex >= 0 && oldIndex != newIndex)
                {
                    questions.RemoveAt(oldIndex);
                    if (newIndex > questions.Count) newIndex = questions.Count;
                    questions.Insert(newIndex, question);

                    for (int i = 0; i < questions.Count; i++)
                    {
                        questions[i].OrderIndex = i;
                        var dbQuestion = await context.Questions.FindAsync(questions[i].Id);
                        if (dbQuestion != null)
                        {
                            dbQuestion.OrderIndex = i;
                        }
                    }
                }
            }
            else
            {
                // Moving between tours or blocks

                // Get the database question first
                var dbMovedQuestion = await context.Questions.FindAsync(questionId);
                if (dbMovedQuestion == null)
                {
                    _saveStatus = "Помилка: питання не знайдено в базі";
                    StateHasChanged();
                    return;
                }

                // Update tour if moving between tours
                if (!isSameTour)
                {
                    sourceTour.Questions.Remove(question);
                    question.TourId = toTourId;
                    dbMovedQuestion.TourId = toTourId;
                    targetTour.Questions.Add(question);
                }

                // Update block assignment
                question.BlockId = toBlockId;
                dbMovedQuestion.BlockId = toBlockId;

                // Reindex source questions (same tour and block as original, excluding moved question)
                var sourceQuestions = sourceTour.Questions
                    .Where(q => q.BlockId == fromBlockId && q.Id != questionId)
                    .OrderBy(q => q.OrderIndex).ToList();

                for (int i = 0; i < sourceQuestions.Count; i++)
                {
                    sourceQuestions[i].OrderIndex = i;
                    var dbQuestion = await context.Questions.FindAsync(sourceQuestions[i].Id);
                    if (dbQuestion != null)
                    {
                        dbQuestion.OrderIndex = i;
                    }
                }

                // Reindex target questions (insert moved question at new position)
                var targetQuestions = targetTour.Questions
                    .Where(q => q.BlockId == toBlockId && q.Id != questionId)
                    .OrderBy(q => q.OrderIndex).ToList();

                if (newIndex > targetQuestions.Count) newIndex = targetQuestions.Count;
                targetQuestions.Insert(newIndex, question);

                for (int i = 0; i < targetQuestions.Count; i++)
                {
                    targetQuestions[i].OrderIndex = i;
                    var dbQuestion = await context.Questions.FindAsync(targetQuestions[i].Id);
                    if (dbQuestion != null)
                    {
                        dbQuestion.OrderIndex = i;
                    }
                }
            }

            await context.SaveChangesAsync();

            // Renumber using the service
            await RenumberingService.RenumberPackage(_package.Id);

            // Reload to get updated numbers
            await ReloadPackageData();

            _saveStatus = "Питання переміщено";
        }
        catch (Exception ex)
        {
            _saveStatus = $"Помилка: {ex.Message}";
        }

        StateHasChanged();
    }

    private async Task CheckUserAsync()
    {
        _userId = await AccessControl.GetCurrentUserId();
    }

    private async Task LoadPackageAsync()
    {
        _isLoading = true;
        _errorMessage = null;

        try
        {
            if (Id == null)
            {
                // Create new package
                await using var context = await DbContextFactory.CreateDbContextAsync();
                _package = new Package
                {
                    Title = "Новий пакет",
                    Description = null,
                    PlayedAt = null,
                    Status = PackageStatus.Draft,
                    OwnerId = _userId,
                    TotalQuestions = 0,
                    Tours = new List<Tour>()
                };

                context.Packages.Add(_package);
                await context.SaveChangesAsync();

                // Redirect to the new package's URL
                Navigation.NavigateTo($"/manage/package/{_package.Id}", replace: true);
            }
            else
            {
                await using var context = await DbContextFactory.CreateDbContextAsync();
                _package = await context.Packages
                    .Include(p => p.Tours)
                        .ThenInclude(t => t.Editors)
                    .Include(p => p.Tours)
                        .ThenInclude(t => t.Blocks)
                            .ThenInclude(b => b.Editors)
                    .Include(p => p.Tours)
                        .ThenInclude(t => t.Questions)
                            .ThenInclude(q => q.Authors)
                    .FirstOrDefaultAsync(p => p.Id == Id);

                if (_package == null)
                {
                    _errorMessage = "Пакет не знайдено.";
                }
                else if (!await AccessControl.CanEditPackage(_package))
                {
                    _errorMessage = "Ви не маєте доступу до цього пакету.";
                    _package = null;
                }
                else
                {
                    // Expand first tour by default
                    if (_package.Tours.Count > 0)
                    {
                        _expandedTours.Add(_package.Tours.First().Id);
                    }
                    // Trigger sortable initialization on next render
                    _needsSortableInit = true;
                }
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Помилка завантаження: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task SavePackageAsync()
    {
        if (_package == null) return;

        _isSaving = true;
        _saveStatus = "Збереження...";
        StateHasChanged();

        try
        {
            // Trim whitespaces from text fields
            _package.Title = _package.Title.Trim();
            _package.Description = _package.Description?.Trim();
            _package.Preamble = _package.Preamble?.Trim();

            await using var context = await DbContextFactory.CreateDbContextAsync();
            var dbPackage = await context.Packages.FindAsync(_package.Id);
            if (dbPackage != null)
            {
                dbPackage.Title = _package.Title;
                dbPackage.Description = _package.Description;
                dbPackage.Preamble = _package.Preamble;
                dbPackage.PlayedAt = _package.PlayedAt;
                dbPackage.Status = _package.Status;
                await context.SaveChangesAsync();
            }
            _saveStatus = "Збережено";
        }
        catch
        {
            _saveStatus = "Помилка збереження";
        }
        finally
        {
            _isSaving = false;
            StateHasChanged();
        }
    }

    private void OnPlayedAtChanged(ChangeEventArgs e)
    {
        if (DateOnly.TryParse(e.Value?.ToString(), out var date))
        {
            _package!.PlayedAt = date;
        }
        else
        {
            _package!.PlayedAt = null;
        }
    }

    private async Task SaveTourAsync(Tour tour)
    {
        _saveStatus = "Збереження туру...";
        StateHasChanged();

        try
        {
            // Trim whitespaces from text fields
            tour.Number = tour.Number.Trim();
            tour.Preamble = tour.Preamble?.Trim();
            tour.Comment = tour.Comment?.Trim();

            await using var context = await DbContextFactory.CreateDbContextAsync();
            var dbTour = await context.Tours
                .Include(t => t.Editors)
                .FirstOrDefaultAsync(t => t.Id == tour.Id);
            if (dbTour != null)
            {
                dbTour.Number = tour.Number;
                dbTour.Preamble = tour.Preamble;
                dbTour.Comment = tour.Comment;

                // Update editors (many-to-many)
                dbTour.Editors.Clear();
                foreach (var editor in tour.Editors)
                {
                    var dbAuthor = await context.Authors.FindAsync(editor.Id);
                    if (dbAuthor != null)
                    {
                        dbTour.Editors.Add(dbAuthor);
                    }
                }

                await context.SaveChangesAsync();
            }
            _saveStatus = "Збережено";
        }
        catch
        {
            _saveStatus = "Помилка збереження";
        }
        StateHasChanged();
    }

    private async Task AddTourAsync()
    {
        if (_package == null) return;

        try
        {
            await using var context = await DbContextFactory.CreateDbContextAsync();

            // Get the next OrderIndex
            var maxOrderIndex = _package.Tours.Count > 0
                ? _package.Tours.Max(t => t.OrderIndex)
                : -1;
            var newOrderIndex = maxOrderIndex + 1;

            // Calculate the new tour number (count of non-warmup tours + 1)
            var mainTourCount = _package.Tours.Count(t => !t.IsWarmup);
            var newNumber = (mainTourCount + 1).ToString();

            var tour = new Tour
            {
                PackageId = _package.Id,
                Number = newNumber,
                OrderIndex = newOrderIndex,
                IsWarmup = false,
                Editors = new List<Author>(),
                Preamble = null,
                Comment = null,
                Questions = new List<Question>()
            };

            context.Tours.Add(tour);
            await context.SaveChangesAsync();

            _package.Tours.Add(tour);
            _expandedTours.Add(tour.Id);
            _saveStatus = "Тур додано";
            _needsSortableInit = true;
        }
        catch (Exception ex)
        {
            _saveStatus = $"Помилка: {ex.Message}";
        }
        StateHasChanged();
    }

    private void ConfirmDeleteTour(Tour tour)
    {
        _tourToDelete = tour;
        _showDeleteTourModal = true;
    }

    private void CancelDeleteTour()
    {
        _tourToDelete = null;
        _showDeleteTourModal = false;
    }

    private async Task DeleteTourAsync()
    {
        if (_tourToDelete == null || _package == null) return;

        try
        {
            await using var context = await DbContextFactory.CreateDbContextAsync();
            var dbTour = await context.Tours
                .Include(t => t.Questions)
                .FirstOrDefaultAsync(t => t.Id == _tourToDelete.Id);

            if (dbTour != null)
            {
                // Update package total questions
                var dbPackage = await context.Packages.FindAsync(_package.Id);
                if (dbPackage != null)
                {
                    dbPackage.TotalQuestions -= dbTour.Questions.Count;
                }

                context.Tours.Remove(dbTour);
                await context.SaveChangesAsync();

                _package.Tours.Remove(_tourToDelete);
                _package.TotalQuestions -= _tourToDelete.Questions.Count;
            }

            _showDeleteTourModal = false;
            _tourToDelete = null;
            _saveStatus = "Тур видалено";
        }
        catch (Exception ex)
        {
            _saveStatus = $"Помилка: {ex.Message}";
        }
        StateHasChanged();
    }

    private async Task AddQuestionAsync(Tour tour)
    {
        if (_package == null) return;

        var question = await CreateQuestionAsync(tour);
        if (question != null)
        {
            _needsSortableInit = true;
            // Find the reloaded tour since package data was reloaded
            var reloadedTour = _package.Tours.FirstOrDefault(t => t.Id == tour.Id);
            if (reloadedTour != null)
            {
                OpenQuestionEditor(reloadedTour, question);
            }
        }
        StateHasChanged();
    }

    private async Task<Question?> CreateQuestionAsync(Tour tour, Block? block = null)
    {
        if (_package == null) return null;

        try
        {
            await using var context = await DbContextFactory.CreateDbContextAsync();

            var newOrderIndex = tour.Questions.Count;

            // If a block is specified, use block editors; otherwise use tour editors
            var editors = block?.Editors ?? tour.Editors;

            var question = new Question
            {
                TourId = tour.Id,
                BlockId = block?.Id,
                OrderIndex = newOrderIndex,
                Number = "0", // Temporary number, will be set by renumbering
                Text = "",
                Answer = "",
                Authors = editors.Select(e => new Author
                {
                    Id = e.Id,
                    FirstName = e.FirstName,
                    LastName = e.LastName
                }).ToList()
            };

            context.Questions.Add(question);

            foreach (var author in question.Authors)
            {
                context.Authors.Attach(author);
            }

            var dbPackage = await context.Packages.FindAsync(_package.Id);
            if (dbPackage != null)
            {
                dbPackage.TotalQuestions++;
            }

            await context.SaveChangesAsync();

            // Renumber to get correct question number based on position
            await RenumberingService.RenumberPackage(_package.Id);

            // Reload to get updated numbers
            await ReloadPackageData();

            // Find the created question in the reloaded data
            var reloadedTour = _package.Tours.FirstOrDefault(t => t.Id == tour.Id);
            var reloadedQuestion = reloadedTour?.Questions.FirstOrDefault(q => q.Id == question.Id);

            _saveStatus = "Питання додано";
            return reloadedQuestion ?? question;
        }
        catch (Exception ex)
        {
            _saveStatus = $"Помилка: {ex.Message}";
            return null;
        }
    }

    private void ConfirmDeleteQuestion(Tour tour, Question question)
    {
        _questionToDelete = question;
        _questionToDeleteTour = tour;
        _showDeleteQuestionModal = true;
    }

    private void CancelDeleteQuestion()
    {
        _questionToDelete = null;
        _questionToDeleteTour = null;
        _showDeleteQuestionModal = false;
    }

    private async Task DeleteQuestionAsync()
    {
        if (_questionToDelete == null || _questionToDeleteTour == null || _package == null) return;

        try
        {
            await using var context = await DbContextFactory.CreateDbContextAsync();
            var dbQuestion = await context.Questions.FindAsync(_questionToDelete.Id);

            if (dbQuestion != null)
            {
                // Update package total
                var dbPackage = await context.Packages.FindAsync(_package.Id);
                if (dbPackage != null)
                {
                    dbPackage.TotalQuestions--;
                }

                context.Questions.Remove(dbQuestion);
                await context.SaveChangesAsync();

                _questionToDeleteTour.Questions.Remove(_questionToDelete);
                _package.TotalQuestions--;
            }

            _showDeleteQuestionModal = false;
            _questionToDelete = null;
            _questionToDeleteTour = null;
            _saveStatus = "Питання видалено";
            _needsSortableInit = true;
        }
        catch (Exception ex)
        {
            _saveStatus = $"Помилка: {ex.Message}";
        }
        StateHasChanged();
    }

    private void OpenQuestionEditor(Tour tour, Question question)
    {
        _editingTour = tour;
        _editingQuestion = question;
        _showQuestionEditor = true;
        _questionSaveStatus = null;
        ResetMediaInputState();
        ValidateMandatoryFields();
    }

    private void CloseQuestionEditor()
    {
        _editingTour = null;
        _editingQuestion = null;
        _showQuestionEditor = false;
        _questionSaveStatus = null;
    }

    private async Task SaveEditingQuestionAsync()
    {
        if (_editingQuestion == null) return;

        try
        {
            // Trim whitespaces from text fields
            _editingQuestion.Number = _editingQuestion.Number.Trim();
            _editingQuestion.Text = _editingQuestion.Text.Trim();
            _editingQuestion.Answer = _editingQuestion.Answer.Trim();
            _editingQuestion.HostInstructions = _editingQuestion.HostInstructions?.Trim();
            _editingQuestion.HandoutText = _editingQuestion.HandoutText?.Trim();
            _editingQuestion.AcceptedAnswers = _editingQuestion.AcceptedAnswers?.Trim();
            _editingQuestion.RejectedAnswers = _editingQuestion.RejectedAnswers?.Trim();
            _editingQuestion.Comment = _editingQuestion.Comment?.Trim();
            _editingQuestion.Source = _editingQuestion.Source?.Trim();

            await using var context = await DbContextFactory.CreateDbContextAsync();
            var dbQuestion = await context.Questions
                .Include(q => q.Authors)
                .FirstOrDefaultAsync(q => q.Id == _editingQuestion.Id);
            if (dbQuestion != null)
            {
                dbQuestion.Number = _editingQuestion.Number;
                dbQuestion.Text = _editingQuestion.Text;
                dbQuestion.Answer = _editingQuestion.Answer;
                dbQuestion.HostInstructions = _editingQuestion.HostInstructions;
                dbQuestion.HandoutText = _editingQuestion.HandoutText;
                dbQuestion.AcceptedAnswers = _editingQuestion.AcceptedAnswers;
                dbQuestion.RejectedAnswers = _editingQuestion.RejectedAnswers;
                dbQuestion.Comment = _editingQuestion.Comment;
                dbQuestion.Source = _editingQuestion.Source;

                // Update authors (many-to-many)
                dbQuestion.Authors.Clear();
                foreach (var author in _editingQuestion.Authors)
                {
                    var dbAuthor = await context.Authors.FindAsync(author.Id);
                    if (dbAuthor != null)
                    {
                        dbQuestion.Authors.Add(dbAuthor);
                    }
                }

                await context.SaveChangesAsync();
            }
            _questionSaveStatus = "Збережено";
        }
        catch
        {
            _questionSaveStatus = "Помилка збереження";
        }
        StateHasChanged();
    }

    private void ValidateMandatoryFields()
    {
        if (_editingQuestion == null) return;

        _isTextEmpty = string.IsNullOrWhiteSpace(_editingQuestion.Text);
        _isAnswerEmpty = string.IsNullOrWhiteSpace(_editingQuestion.Answer);
        _isSourceEmpty = string.IsNullOrWhiteSpace(_editingQuestion.Source);
        _areAuthorsEmpty = _editingQuestion.Authors == null || _editingQuestion.Authors.Count == 0;
    }


    private async Task OnTextBlurAsync()
    {
        ValidateMandatoryFields();
        await SaveEditingQuestionAsync();
    }

    private async Task OnAnswerBlurAsync()
    {
        ValidateMandatoryFields();
        await SaveEditingQuestionAsync();
    }

    private async Task OnSourceBlurAsync()
    {
        ValidateMandatoryFields();
        await SaveEditingQuestionAsync();
    }

    private async Task OnAuthorsChangedAsync()
    {
        ValidateMandatoryFields();
        await SaveEditingQuestionAsync();
    }


    private bool CanNavigatePrev()
    {
        if (_editingQuestion == null || _editingTour == null || _package == null) return false;

        var orderedQuestions = _editingTour.Questions.OrderBy(q => q.OrderIndex).ToList();
        var currentIndex = orderedQuestions.IndexOf(_editingQuestion);

        // Can navigate prev if not first question, or if there's a previous tour
        if (currentIndex > 0) return true;

        var orderedTours = _package.Tours.OrderBy(t => t.OrderIndex).ToList();
        var tourIndex = orderedTours.IndexOf(_editingTour);
        return tourIndex > 0 && orderedTours[tourIndex - 1].Questions.Count > 0;
    }

    private bool CanNavigateNext()
    {
        if (_editingQuestion == null || _editingTour == null || _package == null) return false;

        var orderedQuestions = _editingTour.Questions.OrderBy(q => q.OrderIndex).ToList();
        var currentIndex = orderedQuestions.IndexOf(_editingQuestion);

        // Can navigate next if not last question, or if there's a next tour
        if (currentIndex < orderedQuestions.Count - 1) return true;

        var orderedTours = _package.Tours.OrderBy(t => t.OrderIndex).ToList();
        var tourIndex = orderedTours.IndexOf(_editingTour);
        return tourIndex < orderedTours.Count - 1 && orderedTours[tourIndex + 1].Questions.Count > 0;
    }

    private async Task NavigateToPrevQuestion()
    {
        if (_editingQuestion == null || _editingTour == null || _package == null) return;

        // Save current question first
        await SaveEditingQuestionAsync();

        var orderedQuestions = _editingTour.Questions.OrderBy(q => q.OrderIndex).ToList();
        var currentIndex = orderedQuestions.IndexOf(_editingQuestion);

        if (currentIndex > 0)
        {
            _editingQuestion = orderedQuestions[currentIndex - 1];
        }
        else
        {
            // Go to previous tour
            var orderedTours = _package.Tours.OrderBy(t => t.OrderIndex).ToList();
            var tourIndex = orderedTours.IndexOf(_editingTour);
            if (tourIndex > 0)
            {
                _editingTour = orderedTours[tourIndex - 1];
                _editingQuestion = _editingTour.Questions.OrderBy(q => q.OrderIndex).LastOrDefault();
            }
        }

        _questionSaveStatus = null;
        ResetMediaInputState();
        ValidateMandatoryFields();
        StateHasChanged();
    }

    private async Task NavigateToNextQuestion()
    {
        if (_editingQuestion == null || _editingTour == null || _package == null) return;

        // Save current question first
        await SaveEditingQuestionAsync();

        var orderedQuestions = _editingTour.Questions.OrderBy(q => q.OrderIndex).ToList();
        var currentIndex = orderedQuestions.IndexOf(_editingQuestion);

        if (currentIndex < orderedQuestions.Count - 1)
        {
            _editingQuestion = orderedQuestions[currentIndex + 1];
        }
        else
        {
            // Go to next tour
            var orderedTours = _package.Tours.OrderBy(t => t.OrderIndex).ToList();
            var tourIndex = orderedTours.IndexOf(_editingTour);
            if (tourIndex < orderedTours.Count - 1)
            {
                _editingTour = orderedTours[tourIndex + 1];
                _editingQuestion = _editingTour.Questions.OrderBy(q => q.OrderIndex).FirstOrDefault();
            }
        }

        _questionSaveStatus = null;
        ResetMediaInputState();
        ValidateMandatoryFields();
        StateHasChanged();
    }

    private async Task CreateAndNavigateToNextQuestion()
    {
        if (_editingTour == null || _package == null) return;

        var tourId = _editingTour.Id;
        var currentBlockId = _editingQuestion?.BlockId;

        // Save current question first
        await SaveEditingQuestionAsync();

        // Find the block if the current question belongs to one
        Block? block = null;
        if (currentBlockId.HasValue)
        {
            block = _editingTour.Blocks.FirstOrDefault(b => b.Id == currentBlockId.Value);
        }

        var question = await CreateQuestionAsync(_editingTour, block);
        if (question != null)
        {
            // Update _editingTour reference since package data was reloaded
            _editingTour = _package.Tours.FirstOrDefault(t => t.Id == tourId);
            _editingQuestion = question;
            _questionSaveStatus = null;
            ResetMediaInputState();
            ValidateMandatoryFields();
        }
        StateHasChanged();
    }

    private bool IsExpanded(int tourId) => _expandedTours.Contains(tourId);

    private void ToggleExpand(int tourId)
    {
        if (_expandedTours.Contains(tourId))
            _expandedTours.Remove(tourId);
        else
            _expandedTours.Add(tourId);
    }

    private bool IsBlockExpanded(int blockId) => _expandedBlocks.Contains(blockId);

    private async Task ToggleBlockExpand(int blockId)
    {
        if (_expandedBlocks.Contains(blockId))
        {
            _expandedBlocks.Remove(blockId);
        }
        else
        {
            _expandedBlocks.Add(blockId);
            // Need to initialize sortable after DOM is updated
            StateHasChanged();
            await Task.Delay(50); // Wait for DOM to render
            await InitializeBlockQuestionsSortable(blockId);
        }
    }

    private async Task InitializeBlockQuestionsSortable(int blockId)
    {
        if (_package == null || _dotNetRef == null) return;

        try
        {
            // Find the block and its tour
            foreach (var tour in _package.Tours)
            {
                var block = tour.Blocks.FirstOrDefault(b => b.Id == blockId);
                if (block != null)
                {
                    await JS.InvokeVoidAsync("sortableInterop.initBlockQuestionsSortable",
                        $"questions-block-{block.Id}", tour.Id, block.Id, _dotNetRef);
                    break;
                }
            }
        }
        catch (JSDisconnectedException)
        {
            // Ignore - component is being disposed
        }
        catch (JSException ex)
        {
            Console.WriteLine($"Error initializing block questions sortable: {ex.Message}");
        }
    }


    private static string GetStatusBadgeClass(PackageStatus status) => status switch
    {
        PackageStatus.Draft => "bg-secondary",
        PackageStatus.Published => "bg-success",
        PackageStatus.Archived => "bg-warning text-dark",
        _ => "bg-secondary"
    };

    private static string GetStatusDisplayName(PackageStatus status) => status switch
    {
        PackageStatus.Draft => "Чернетка",
        PackageStatus.Published => "Опубліковано",
        PackageStatus.Archived => "Архів",
        _ => "Невідомо"
    };

    // ==================== Media Upload Methods ====================

    private static string GetFileName(string? url)
    {
        if (string.IsNullOrEmpty(url)) return "";
        var lastSlash = url.LastIndexOf('/');
        return lastSlash >= 0 ? url[(lastSlash + 1)..] : url;
    }

    /// <summary>
    /// Represents the target for media attachment operations.
    /// </summary>
    private enum MediaTarget
    {
        Handout,
        Comment
    }

    private async Task OnHandoutFileSelected(InputFileChangeEventArgs e)
    {
        await HandleFileUploadAsync(e.File, MediaTarget.Handout);
    }

    private async Task OnCommentFileSelected(InputFileChangeEventArgs e)
    {
        await HandleFileUploadAsync(e.File, MediaTarget.Comment);
    }

    private async Task DeleteHandoutMediaAsync()
    {
        await HandleMediaDeleteAsync(MediaTarget.Handout);
    }

    private async Task DeleteCommentMediaAsync()
    {
        await HandleMediaDeleteAsync(MediaTarget.Comment);
    }

    /// <summary>
    /// Unified handler for file upload operations (handout or comment).
    /// </summary>
    private async Task HandleFileUploadAsync(IBrowserFile file, MediaTarget target)
    {
        if (_editingQuestion == null) return;

        SetMediaOperationState(target, isLoading: true, error: null);
        StateHasChanged();

        try
        {
            // Validate file
            var (isValid, validationError) = MediaService.ValidateFile(file.Name, file.Size);
            if (!isValid)
            {
                SetMediaOperationState(target, isLoading: false, error: validationError);
                return;
            }

            // Remember existing URL for cleanup after successful upload
            var existingUrl = target == MediaTarget.Handout
                ? _editingQuestion.HandoutUrl
                : _editingQuestion.CommentAttachmentUrl;

            // Upload new file
            await using var stream = file.OpenReadStream(MaxUploadSize);
            var result = await MediaService.UploadAsync(stream, file.Name);

            if (!result.Success)
            {
                SetMediaOperationState(target, isLoading: false, error: result.ErrorMessage ?? "Помилка завантаження");
                return;
            }

            // Update question with new URL
            SetMediaUrl(target, result.RelativeUrl);

            // Save to database
            await using var context = await DbContextFactory.CreateDbContextAsync();
            var question = await context.Questions.FindAsync(_editingQuestion.Id);
            if (question != null)
            {
                if (target == MediaTarget.Handout)
                {
                    question.HandoutUrl = result.RelativeUrl;
                }
                else
                {
                    question.CommentAttachmentUrl = result.RelativeUrl;
                }
                await context.SaveChangesAsync();
            }

            // Delete old file after successful save
            if (!string.IsNullOrEmpty(existingUrl))
            {
                MediaService.Delete(existingUrl);
            }

            _questionSaveStatus = "Медіа завантажено";
        }
        catch (Exception ex)
        {
            SetMediaOperationState(target, isLoading: false, error: $"Помилка: {ex.Message}");
        }
        finally
        {
            SetMediaOperationState(target, isLoading: false, error: null, preserveError: true);
            StateHasChanged();
        }
    }

    /// <summary>
    /// Unified handler for media delete operations (handout or comment).
    /// </summary>
    private async Task HandleMediaDeleteAsync(MediaTarget target)
    {
        if (_editingQuestion == null) return;

        SetMediaOperationState(target, isLoading: true, error: null);
        StateHasChanged();

        try
        {
            // Get existing URL
            var existingUrl = target == MediaTarget.Handout
                ? _editingQuestion.HandoutUrl
                : _editingQuestion.CommentAttachmentUrl;

            if (string.IsNullOrEmpty(existingUrl))
            {
                SetMediaOperationState(target, isLoading: false, error: "Немає медіа для видалення");
                return;
            }

            // Update question in database first
            await using var context = await DbContextFactory.CreateDbContextAsync();
            var question = await context.Questions.FindAsync(_editingQuestion.Id);
            if (question != null)
            {
                if (target == MediaTarget.Handout)
                {
                    question.HandoutUrl = null;
                }
                else
                {
                    question.CommentAttachmentUrl = null;
                }
                await context.SaveChangesAsync();
            }

            // Delete file from disk
            MediaService.Delete(existingUrl);

            // Update local state
            SetMediaUrl(target, null);
            _questionSaveStatus = "Медіа видалено";
        }
        catch (Exception ex)
        {
            SetMediaOperationState(target, isLoading: false, error: $"Помилка: {ex.Message}");
        }
        finally
        {
            SetMediaOperationState(target, isLoading: false, error: null, preserveError: true);
            StateHasChanged();
        }
    }

    /// <summary>
    /// Sets the loading state and error message for a media operation.
    /// </summary>
    private void SetMediaOperationState(MediaTarget target, bool isLoading, string? error, bool preserveError = false)
    {
        if (target == MediaTarget.Handout)
        {
            _isUploadingHandout = isLoading;
            if (!preserveError) _handoutUploadError = error;
        }
        else
        {
            _isUploadingComment = isLoading;
            if (!preserveError) _commentUploadError = error;
        }
    }

    /// <summary>
    /// Sets the media URL on the editing question.
    /// </summary>
    private void SetMediaUrl(MediaTarget target, string? url)
    {
        if (_editingQuestion == null) return;

        if (target == MediaTarget.Handout)
        {
            _editingQuestion.HandoutUrl = url;
        }
        else
        {
            _editingQuestion.CommentAttachmentUrl = url;
        }
    }

    /// <summary>
    /// Resets the InputFile components by generating new keys, forcing re-render.
    /// Also clears any upload errors.
    /// </summary>
    private void ResetMediaInputState()
    {
        _handoutInputKey = Guid.NewGuid();
        _commentInputKey = Guid.NewGuid();
        _handoutUploadError = null;
        _commentUploadError = null;
    }

    /// <summary>
    /// Attempts to delete an author if they are orphaned (no questions, no tours, and not linked to a user).
    /// </summary>
    private async Task TryDeleteOrphanedAuthorAsync(Author author)
    {
        await AuthorService.TryDeleteAuthorIfOrphaned(author.Id);
    }

    private async Task OnNumberingModeChanged(ChangeEventArgs e)
    {
        if (_package == null) return;

        if (Enum.TryParse<QuestionNumberingMode>(e.Value?.ToString(), out var mode))
        {
            _package.NumberingMode = mode;

            try
            {
                _saveStatus = "Зміна режиму нумерації...";
                StateHasChanged();

                await using var context = await DbContextFactory.CreateDbContextAsync();
                var dbPackage = await context.Packages.FindAsync(_package.Id);
                if (dbPackage != null)
                {
                    dbPackage.NumberingMode = mode;
                    await context.SaveChangesAsync();
                }

                // Renumber using the service
                await RenumberingService.RenumberPackage(_package.Id);

                // Reload to get updated numbers
                await ReloadPackageData();

                _saveStatus = "Режим нумерації змінено";
            }
            catch (Exception ex)
            {
                _saveStatus = $"Помилка: {ex.Message}";
            }
            StateHasChanged();
        }
    }

    private async Task OnWarmupChanged(Tour tour, bool isWarmup)
    {
        if (_package == null) return;

        try
        {
            _saveStatus = isWarmup ? "Встановлення розминки..." : "Скасування розминки...";
            StateHasChanged();

            await using var context = await DbContextFactory.CreateDbContextAsync();

            // Unset warmup on all tours first
            var allTours = await context.Tours.Where(t => t.PackageId == _package.Id).ToListAsync();
            foreach (var t in allTours)
            {
                t.IsWarmup = false;
            }

            if (isWarmup)
            {
                // Set the specified tour as warmup
                var dbTour = allTours.FirstOrDefault(t => t.Id == tour.Id);
                if (dbTour != null)
                {
                    dbTour.IsWarmup = true;
                    dbTour.OrderIndex = 0;

                    // Shift other tours
                    var otherTours = allTours
                        .Where(t => t.Id != tour.Id)
                        .OrderBy(t => t.OrderIndex)
                        .ToList();
                    for (int i = 0; i < otherTours.Count; i++)
                    {
                        otherTours[i].OrderIndex = i + 1;
                    }
                }
            }

            await context.SaveChangesAsync();

            // Renumber using the service
            await RenumberingService.RenumberPackage(_package.Id);

            // Reload to get updated data
            await ReloadPackageData();

            _saveStatus = isWarmup ? "Розминку встановлено" : "Розминку скасовано";
        }
        catch (Exception ex)
        {
            _saveStatus = $"Помилка: {ex.Message}";
        }
        StateHasChanged();
    }

    private async Task ReloadPackageData()
    {
        if (_package == null) return;

        await using var context = await DbContextFactory.CreateDbContextAsync();
        var reloadedPackage = await context.Packages
            .Include(p => p.Tours)
                .ThenInclude(t => t.Editors)
            .Include(p => p.Tours)
                .ThenInclude(t => t.Blocks)
                    .ThenInclude(b => b.Editors)
            .Include(p => p.Tours)
                .ThenInclude(t => t.Questions)
                    .ThenInclude(q => q.Authors)
            .AsNoTracking()
            .FirstOrDefaultAsync(p => p.Id == _package.Id);

        if (reloadedPackage != null)
        {
            _package = reloadedPackage;
        }
    }

    // Block management methods

    private async Task AddBlockAsync(Tour tour)
    {
        if (_package == null) return;

        try
        {
            await using var context = await DbContextFactory.CreateDbContextAsync();

            var newOrderIndex = tour.Blocks.Count;
            var isFirstBlock = newOrderIndex == 0;

            var block = new Block
            {
                TourId = tour.Id,
                OrderIndex = newOrderIndex,
                Name = null,
                Preamble = null,
                Editors = new List<Author>(),
                Questions = new List<Question>()
            };

            context.Blocks.Add(block);
            await context.SaveChangesAsync();

            // If this is the first block, assign all existing unassigned questions to it
            if (isFirstBlock)
            {
                var unassignedQuestions = await context.Questions
                    .Where(q => q.TourId == tour.Id && q.BlockId == null)
                    .ToListAsync();

                foreach (var question in unassignedQuestions)
                {
                    question.BlockId = block.Id;
                }
                await context.SaveChangesAsync();

                // Update local state
                foreach (var question in tour.Questions.Where(q => q.BlockId == null))
                {
                    question.BlockId = block.Id;
                }
            }

            tour.Blocks.Add(block);

            // Auto-expand the newly added block
            _expandedBlocks.Add(block.Id);

            // Initialize sortables after DOM is updated
            StateHasChanged();
            await Task.Delay(50);
            await InitializeBlockQuestionsSortable(block.Id);

            // If this is the first block, also initialize the blocks sortable
            if (isFirstBlock)
            {
                await JS.InvokeVoidAsync("sortableInterop.initBlocksSortable",
                    $"blocks-tour-{tour.Id}", tour.Id, _dotNetRef);
            }
        }
        catch (Exception ex)
        {
            _saveStatus = $"Помилка: {ex.Message}";
        }
        StateHasChanged();
    }

    private async Task SaveBlockAsync(Block block)
    {
        _saveStatus = "Збереження блоку...";
        StateHasChanged();

        try
        {
            // Trim whitespaces from text fields
            block.Name = block.Name?.Trim();
            block.Preamble = block.Preamble?.Trim();

            await using var context = await DbContextFactory.CreateDbContextAsync();
            var dbBlock = await context.Blocks
                .Include(b => b.Editors)
                .FirstOrDefaultAsync(b => b.Id == block.Id);

            if (dbBlock != null)
            {
                dbBlock.Name = block.Name;
                dbBlock.Preamble = block.Preamble;
                dbBlock.OrderIndex = block.OrderIndex;

                // Update editors (many-to-many)
                dbBlock.Editors.Clear();
                foreach (var editor in block.Editors)
                {
                    var dbAuthor = await context.Authors.FindAsync(editor.Id);
                    if (dbAuthor != null)
                    {
                        dbBlock.Editors.Add(dbAuthor);
                    }
                }

                await context.SaveChangesAsync();
            }
            _saveStatus = "Збережено";
        }
        catch
        {
            _saveStatus = "Помилка збереження";
        }
        StateHasChanged();
    }

    private void ConfirmDeleteBlock(Tour tour, Block block)
    {
        _blockToDelete = block;
        _blockToDeleteTour = tour;
        _showDeleteBlockModal = true;
    }

    private void CancelDeleteBlock()
    {
        _blockToDelete = null;
        _blockToDeleteTour = null;
        _showDeleteBlockModal = false;
    }

    private async Task DeleteBlockAsync()
    {
        if (_blockToDelete == null || _blockToDeleteTour == null || _package == null) return;

        try
        {
            await using var context = await DbContextFactory.CreateDbContextAsync();

            // Set BlockId = null for all questions in this block (they stay in the tour)
            var questionsInBlock = await context.Questions
                .Where(q => q.BlockId == _blockToDelete.Id)
                .ToListAsync();

            foreach (var question in questionsInBlock)
            {
                question.BlockId = null;
            }

            // Also update local state
            foreach (var question in _blockToDeleteTour.Questions.Where(q => q.BlockId == _blockToDelete.Id))
            {
                question.BlockId = null;
            }

            // Delete the block
            var dbBlock = await context.Blocks.FindAsync(_blockToDelete.Id);
            if (dbBlock != null)
            {
                context.Blocks.Remove(dbBlock);
            }

            await context.SaveChangesAsync();

            // Remove from local state
            _blockToDeleteTour.Blocks.Remove(_blockToDelete);

            // Reindex remaining blocks
            var orderedBlocks = _blockToDeleteTour.Blocks.OrderBy(b => b.OrderIndex).ToList();
            for (int i = 0; i < orderedBlocks.Count; i++)
            {
                orderedBlocks[i].OrderIndex = i;
            }

            _showDeleteBlockModal = false;
            _blockToDelete = null;
            _blockToDeleteTour = null;
            _saveStatus = "Блок видалено";
        }
        catch (Exception ex)
        {
            _saveStatus = $"Помилка: {ex.Message}";
        }
        StateHasChanged();
    }

    private async Task AddQuestionToBlockAsync(Tour tour, Block block)
    {
        if (_package == null) return;

        try
        {
            await using var context = await DbContextFactory.CreateDbContextAsync();

            var newOrderIndex = tour.Questions.Count;

            var question = new Question
            {
                TourId = tour.Id,
                BlockId = block.Id,
                OrderIndex = newOrderIndex,
                Number = "0", // Temporary number, will be set by renumbering
                Text = "",
                Answer = "",
                Authors = block.Editors.Select(e => new Author
                {
                    Id = e.Id,
                    FirstName = e.FirstName,
                    LastName = e.LastName
                }).ToList()
            };

            context.Questions.Add(question);

            foreach (var author in question.Authors)
            {
                context.Authors.Attach(author);
            }

            var dbPackage = await context.Packages.FindAsync(_package.Id);
            if (dbPackage != null)
            {
                dbPackage.TotalQuestions++;
            }

            await context.SaveChangesAsync();

            // Renumber to get correct question number based on position
            await RenumberingService.RenumberPackage(_package.Id);

            // Reload to get updated numbers
            await ReloadPackageData();

            // Find the created question in the reloaded data
            var reloadedTour = _package.Tours.FirstOrDefault(t => t.Id == tour.Id);
            var reloadedQuestion = reloadedTour?.Questions.FirstOrDefault(q => q.Id == question.Id);

            if (reloadedTour != null && reloadedQuestion != null)
            {
                OpenQuestionEditor(reloadedTour, reloadedQuestion);
            }
            _saveStatus = "Питання додано";
        }
        catch (Exception ex)
        {
            _saveStatus = $"Помилка: {ex.Message}";
        }
        StateHasChanged();
    }
}

