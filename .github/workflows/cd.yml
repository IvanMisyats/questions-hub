name: CD

env:
  PROJECT_NAME: ivanmisyats/questions-hub

on:
  # Trigger after CI workflow completes successfully on main
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches:
      - main
  # Allow manual deployment
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Only run if CI succeeded (for workflow_run trigger) or manual trigger
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      # 1. Check out the code
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Log in to GitHub Container Registry (GHCR)
      - name: Login to GitHub Container Registry
        run: echo "${{ secrets.REPO_TOKEN }}" | docker login ghcr.io -u "${{ github.repository_owner }}" --password-stdin

      # 3. Build Docker image
      - name: Build Docker image
        run: docker buildx build --load -f QuestionsHub.Blazor/Dockerfile -t ghcr.io/${{ env.PROJECT_NAME }}:latest .

      # 4. Push Docker image to GHCR
      - name: Push Docker image
        run: docker push ghcr.io/${{ env.PROJECT_NAME }}:latest

      # 5. Copy deployment files to VPS
      - name: Copy deployment files to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          port: 55055
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "docker-compose.yml,db/"
          target: "~/questions-hub/"

      # 6. Deploy to VPS via SSH
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          port: 55055
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd ~/questions-hub

            # Load environment variables from .env file
            # Note: ~/.env file must be pre-created on VPS with:
            #   - POSTGRES_ROOT_PASSWORD
            #   - QUESTIONSHUB_PASSWORD
            #   - ADMIN_EMAIL
            #   - ADMIN_PASSWORD
            #   - EMAIL_API_KEY (Mailjet API Key)
            #   - EMAIL_API_SECRET (Mailjet API Secret)
            #   - TELEGRAM_BOT_TOKEN (Telegram Bot API token)
            set -a
            source ~/.env
            set +a

            # Export variables for docker-compose
            export POSTGRES_ROOT_PASSWORD
            export QUESTIONSHUB_PASSWORD
            export ADMIN_EMAIL
            export ADMIN_PASSWORD
            export EMAIL_API_KEY
            export EMAIL_API_SECRET
            export TELEGRAM_BOT_TOKEN
            export POSTGRES_DATA_PATH=~/questions-hub/data/postgres
            export UPLOADS_PATH=~/questions-hub/uploads
            export KEYS_PATH=~/questions-hub/keys

            # Log in to GHCR on the VPS
            echo "${{ secrets.REPO_TOKEN }}" | docker login ghcr.io -u ${{ github.repository_owner }} --password-stdin

            # Pull the latest image from GHCR
            docker pull ghcr.io/${{ env.PROJECT_NAME }}:latest

            # Create required directories
            mkdir -p "$POSTGRES_DATA_PATH" \
                     "$UPLOADS_PATH/handouts" \
                     "$UPLOADS_PATH/packages" \
                     "$UPLOADS_PATH/jobs" \
                     "$KEYS_PATH"

            # Set directory permissions only (don't recurse into files to avoid errors on root-owned files)
            chmod 755 "$UPLOADS_PATH" "$UPLOADS_PATH/handouts" "$UPLOADS_PATH/packages" "$UPLOADS_PATH/jobs"

            # Set secure permissions for keys directory (readable/writable only by owner)
            chmod 700 "$KEYS_PATH"

            # Stop existing containers (if any)
            docker compose --profile production down 2>/dev/null || true

            # Start services using docker-compose with production profile
            # This runs: postgres -> db-setup -> web (in dependency order)
            docker compose --profile production up -d

            # Clean up old images
            docker image prune -f

            echo "Deployment complete!"

