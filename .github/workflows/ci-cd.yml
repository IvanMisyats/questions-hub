name: CI/CD Pipeline

env:
  PROJECT_NAME: ivanmisyats/questions-hub

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. Check out the code
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Set up .NET SDK
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '10.0.x'

      # 3. Restore dependencies
      - name: Restore dependencies
        run: dotnet restore

      # 4. Build the project
      - name: Build
        run: dotnet build --no-restore

      # 5. Run tests
      # - name: Run tests
      #   run: dotnet test --no-build --verbosity normal

      # 6. Log in to GitHub Container Registry (GHCR)
      - name: Login to GitHub Container Registry
        run: echo "${{ secrets.REPO_TOKEN }}" | docker login ghcr.io -u "${{ github.repository_owner || env.GITHUB_ACTOR }}" --password-stdin

      # 7. Build Docker image
      - name: Build Docker image
        run: docker buildx build --load -f QuestionsHub.Blazor/Dockerfile -t ghcr.io/${{ env.PROJECT_NAME }}:latest .

      # 8. Push Docker image to GHCR
      - name: Push Docker image
        run: docker push ghcr.io/${{ env.PROJECT_NAME }}:latest

      # 9. Copy init-db.sh to VPS using SSH (avoiding SCP permission issues)
      - name: Copy init script to VPS
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          port: 55055
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            # Ensure directory exists with proper permissions
            mkdir -p ~/questions-hub
            chmod 755 ~/questions-hub
            
            # Create init-db.sh with content from stdin
            cat > ~/questions-hub/init-db.sh << 'INITDB_EOF'
            #!/bin/bash
            set -e
            
            # Create questionshub user with limited privileges
            psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "$POSTGRES_DB" <<-EOSQL
                -- Create questionshub user if not exists
                DO
                \$\$
                BEGIN
                   IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = 'questionshub') THEN
                      CREATE USER questionshub WITH PASSWORD '$QUESTIONSHUB_PASSWORD';
                   END IF;
                END
                \$\$;
            
                -- Grant privileges to questionshub user
                GRANT CONNECT ON DATABASE questionshub TO questionshub;
                GRANT USAGE, CREATE ON SCHEMA public TO questionshub;
                GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO questionshub;
                GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO questionshub;
                ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO questionshub;
                ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT USAGE, SELECT ON SEQUENCES TO questionshub;
            EOSQL
            
            echo "Database user 'questionshub' created successfully"
            INITDB_EOF
            
            # Set proper permissions
            chmod 755 ~/questions-hub/init-db.sh
            chown $(whoami):$(whoami) ~/questions-hub/init-db.sh

      # 11. Deploy to VPS via SSH
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          port: 55055
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd ~/questions-hub
            
            # Load environment variables from .env file
            set -a
            source .env
            set +a
            
            # Log in to GHCR on the VPS
            echo "${{ secrets.REPO_TOKEN }}" | docker login ghcr.io -u ${{ github.repository_owner }} --password-stdin
          
            # Pull the latest image from GHCR
            docker pull ghcr.io/${{ env.PROJECT_NAME }}:latest

            # Ensure init-db.sh is executable
            chmod +x init-db.sh

            # Create data directory
            mkdir -p ~/questions-hub-data/postgres_data

            # Create docker network if not exists
            docker network create questions-hub-network 2>/dev/null || true

            # Stop and remove existing containers
            docker stop questions-hub-web questions-hub-db 2>/dev/null || true
            docker rm questions-hub-web questions-hub-db 2>/dev/null || true

            # Start PostgreSQL container
            docker run -d \
              --name questions-hub-db \
              --network questions-hub-network \
              --restart unless-stopped \
              -e POSTGRES_USER=postgres \
              -e POSTGRES_PASSWORD=${POSTGRES_ROOT_PASSWORD} \
              -e POSTGRES_DB=questionshub \
              -e QUESTIONSHUB_PASSWORD=${QUESTIONSHUB_PASSWORD} \
              -v ~/questions-hub-data/postgres_data:/var/lib/postgresql/data \
              -v ~/questions-hub/init-db.sh:/docker-entrypoint-initdb.d/init-db.sh:ro \
              --memory=768m \
              --memory-swap=1g \
              --health-cmd="pg_isready -U postgres -d questionshub" \
              --health-interval=10s \
              --health-timeout=5s \
              --health-retries=5 \
              postgres:16-alpine \
              postgres \
                -c shared_buffers=128MB \
                -c work_mem=4MB \
                -c maintenance_work_mem=64MB \
                -c effective_cache_size=256MB \
                -c max_connections=20

            # Wait for PostgreSQL to be healthy
            echo "Waiting for PostgreSQL to be ready..."
            until docker exec questions-hub-db pg_isready -U postgres -d questionshub; do
              sleep 2
            done

            # Start web app container
            docker run -d \
              --name questions-hub-web \
              --network questions-hub-network \
              --restart unless-stopped \
              -p 8080:8080 \
              -e ASPNETCORE_ENVIRONMENT=Production \
              -e "ConnectionStrings__DefaultConnection=Host=questions-hub-db;Port=5432;Database=questionshub;Username=questionshub;Password=${QUESTIONSHUB_PASSWORD}" \
              --memory=512m \
              --memory-swap=768m \
              ghcr.io/${{ env.PROJECT_NAME }}:latest

            # Clean up old images
            docker image prune -f
